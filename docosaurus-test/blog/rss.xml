<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Petr's Blog Blog</title>
        <link>https://blog-test.ruzicka.dev/docosaurus-test/blog</link>
        <description>Petr's Blog Blog</description>
        <lastBuildDate>Sun, 03 Oct 2021 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[First_post]]></title>
            <link>https://blog-test.ruzicka.dev/docosaurus-test/blog/first-post</link>
            <guid>https://blog-test.ruzicka.dev/docosaurus-test/blog/first-post</guid>
            <pubDate>Sun, 03 Oct 2021 00:00:00 GMT</pubDate>
            <description><![CDATA[Test123 description]]></description>
            <content:encoded><![CDATA[<p>Test 123</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"arn:aws:secretsmanager:*:*:secret:*"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>first</category>
            <category>first_post</category>
        </item>
        <item>
            <title><![CDATA[Welcome]]></title>
            <link>https://blog-test.ruzicka.dev/docosaurus-test/blog/welcome</link>
            <guid>https://blog-test.ruzicka.dev/docosaurus-test/blog/welcome</guid>
            <pubDate>Thu, 26 Aug 2021 00:00:00 GMT</pubDate>
            <description><![CDATA[Docusaurus blogging features are powered by the blog plugin.]]></description>
            <content:encoded><![CDATA[<p><a href="https://docusaurus.io/docs/blog" target="_blank" rel="noopener noreferrer">Docusaurus blogging features</a> are powered by the <a href="https://docusaurus.io/docs/api/plugins/@docusaurus/plugin-content-blog" target="_blank" rel="noopener noreferrer">blog plugin</a>.</p>
<p>Simply add Markdown files (or folders) to the <code>blog</code> directory.</p>
<p>Regular blog authors can be added to <code>authors.yml</code>.</p>
<p>The blog post date can be extracted from filenames, such as:</p>
<ul>
<li><code>2019-05-30-welcome.md</code></li>
<li><code>2019-05-30-welcome/index.md</code></li>
</ul>
<p>A blog post folder can be convenient to co-locate blog post images:</p>
<p><img decoding="async" loading="lazy" alt="Docusaurus Plushie" src="https://blog-test.ruzicka.dev/docosaurus-test/assets/images/docusaurus-plushie-banner-a60f7593abca1e3eef26a9afa244e4fb.jpeg" width="1500" height="500" class="img_ev3q"></p>
<p>The blog supports tags as well!</p>
<p><strong>And if you don't want a blog</strong>: just delete this directory, and use <code>blog: false</code> in your Docusaurus config.</p>]]></content:encoded>
            <category>facebook</category>
            <category>hello</category>
            <category>docusaurus</category>
        </item>
        <item>
            <title><![CDATA[MDX Blog Post]]></title>
            <link>https://blog-test.ruzicka.dev/docosaurus-test/blog/mdx-blog-post</link>
            <guid>https://blog-test.ruzicka.dev/docosaurus-test/blog/mdx-blog-post</guid>
            <pubDate>Sun, 01 Aug 2021 00:00:00 GMT</pubDate>
            <description><![CDATA[Blog posts support Docusaurus Markdown features, such as MDX.]]></description>
            <content:encoded><![CDATA[<p>Blog posts support <a href="https://docusaurus.io/docs/markdown-features" target="_blank" rel="noopener noreferrer">Docusaurus Markdown features</a>, such as <a href="https://mdxjs.com/" target="_blank" rel="noopener noreferrer">MDX</a>.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Use the power of React to create interactive blog posts.</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">button onClick</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">alert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'button clicked!'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token maybe-class-name">Click</span><span class="token plain"> me</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">button</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><button>Click me!</button></div></div>]]></content:encoded>
            <category>docusaurus</category>
        </item>
        <item>
            <title><![CDATA[Test EKS Post]]></title>
            <link>https://blog-test.ruzicka.dev/docosaurus-test/blog/test-eks-post</link>
            <guid>https://blog-test.ruzicka.dev/docosaurus-test/blog/test-eks-post</guid>
            <pubDate>Thu, 10 Dec 2020 00:00:00 GMT</pubDate>
            <description><![CDATA[![Amazon EKS](https://raw.githubusercontent.com/cncf/landscape/7f5b02ecba914a32912e77fc78e1c54d1c2f98ec/hosted_logos/amazon-eks.svg?sanitize=true]]></description>
            <content:encoded><![CDATA[<p><img decoding="async" loading="lazy" src="https://raw.githubusercontent.com/cncf/landscape/7f5b02ecba914a32912e77fc78e1c54d1c2f98ec/hosted_logos/amazon-eks.svg?sanitize=true" alt="Amazon EKS" title="Amazon EKS" class="img_ev3q"></p>
<p>Before starting with the main content, it's necessary to provision
the <a href="https://aws.amazon.com/eks/" target="_blank" rel="noopener noreferrer">Amazon EKS</a> in AWS.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="requirements">Requirements<a class="hash-link" aria-label="Direct link to Requirements" title="Direct link to Requirements" href="https://blog-test.ruzicka.dev/docosaurus-test/blog/test-eks-post#requirements">​</a></h2>
<p>If you would like to follow this documents and it's task you will need to set up
few environment variables.</p>
<p>The <code>LETSENCRYPT_ENVIRONMENT</code> variable should be one of:</p>
<ul>
<li><code>staging</code> - Let’s Encrypt will create testing certificate (not valid)</li>
<li><code>production</code> - Let’s Encrypt will create valid certificate (use with care)</li>
</ul>
<p><code>BASE_DOMAIN</code> contains DNS records for all your Kubernetes clusters. The cluster
names will look like <code>CLUSTER_NAME</code>.<code>BASE_DOMAIN</code> (<code>kube1.k8s.mylabs.dev</code>).</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Hostname / FQDN definitions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export BASE_DOMAIN=${BASE_DOMAIN:-k8s.mylabs.dev}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CLUSTER_NAME=${CLUSTER_NAME:-kube1}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CLUSTER_FQDN="${CLUSTER_NAME}.${BASE_DOMAIN}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export KUBECONFIG=${PWD}/kubeconfig-${CLUSTER_NAME}.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># * "production" - valid certificates signed by Lets Encrypt ""</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># * "staging" - not trusted certs signed by Lets Encrypt "Fake LE Intermediate X1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export LETSENCRYPT_ENVIRONMENT="staging"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export LETSENCRYPT_CERTIFICATE="https://letsencrypt.org/certs/staging/letsencrypt-stg-root-x1.pem"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># export LETSENCRYPT_ENVIRONMENT="production"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># export LETSENCRYPT_CERTIFICATE="https://letsencrypt.org/certs/lets-encrypt-r3.pem"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export MY_EMAIL="petr.ruzicka@gmail.com"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># GitHub Organization + Team where are the users who will have the admin access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># to K8s resources (Grafana). Only users in GitHub organization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># (MY_GITHUB_ORG_NAME) will be able to access the apps via ingress.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export MY_GITHUB_ORG_NAME="ruzickap-org"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export MY_GITHUB_USERNAME="ruzickap"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># AWS Region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export AWS_DEFAULT_REGION="eu-west-1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export SLACK_CHANNEL="mylabs"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Tags used to tag the AWS resources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export TAGS="Owner=${MY_EMAIL} Environment=Dev Group=Cloud_Native Squad=Cloud_Container_Platform compliance:na:defender=bottlerocket"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo -e "${MY_EMAIL} | ${LETSENCRYPT_ENVIRONMENT} | ${CLUSTER_NAME} | ${BASE_DOMAIN} | ${CLUSTER_FQDN}\n${TAGS}"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Prepare GitHub OAuth "access" credentials ans AWS "access" variables.</p>
<p>You will need to configure AWS CLI: <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html" target="_blank" rel="noopener noreferrer">Configuring the AWS CLI</a></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Common password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export MY_PASSWORD="xxxx"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># AWS Credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export AWS_ACCESS_KEY_ID=""</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export AWS_SECRET_ACCESS_KEY=""</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export AWS_CONSOLE_ADMIN_ROLE_ARN="arn:aws:iam::7xxxxxxxxxx7:role/xxxxxxxxxxxxxN"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># GitHub Organization OAuth Apps credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID="3xxxxxxxxxxxxxxxxxx3"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET="7xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx8"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID="4xxxxxxxxxxxxxxxxxx4"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET="7xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxa"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Sysdig credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export SYSDIG_AGENT_ACCESSKEY="xxx"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Aqua credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export AQUA_REGISTRY_USERNAME="xxx"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export AQUA_REGISTRY_PASSWORD="xxx"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export AQUA_ENFORCER_TOKEN="xxx"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Splunk credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export SPLUNK_HOST="xxx"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export SPLUNK_TOKEN="xxx"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export SPLUNK_INDEX_NAME="xxx"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Slack incoming webhook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export SLACK_INCOMING_WEBHOOK_URL="https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export SLACK_BOT_API_TOKEN="xxxx-xxxxxxxxxxxxx-xxxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxP"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Okta configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export OKTA_ISSUER="https://exxxxxxx-xxxxx-xx.okta.com"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export OKTA_CLIENT_ID="0xxxxxxxxxxxxxxxxxx7"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export OKTA_CLIENT_SECRET="1xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxH"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Verify if all the necessary variables were set:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">case "${CLUSTER_NAME}" in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kube1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID=${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID:-${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID_KUBE1}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET=${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET:-${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET_KUBE1}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID=${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID:-${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID_KUBE1}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET=${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET:-${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET_KUBE1}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kube2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID=${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID:-${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID_KUBE2}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET=${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET:-${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET_KUBE2}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID=${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID:-${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID_KUBE2}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET=${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET:-${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET_KUBE2}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo "Unsupported cluster name: ${CLUSTER_NAME} !"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">esac</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">: "${AWS_ACCESS_KEY_ID?}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">: "${AWS_SECRET_ACCESS_KEY?}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">: "${AWS_CONSOLE_ADMIN_ROLE_ARN?}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">: "${GITHUB_TOKEN?}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">: "${SLACK_INCOMING_WEBHOOK_URL?}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">: "${SLACK_BOT_API_TOKEN?}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">: "${MY_PASSWORD?}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">: "${OKTA_ISSUER?}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">: "${OKTA_CLIENT_ID?}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">: "${OKTA_CLIENT_SECRET?}"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prepare-the-local-working-environment">Prepare the local working environment<a class="hash-link" aria-label="Direct link to Prepare the local working environment" title="Direct link to Prepare the local working environment" href="https://blog-test.ruzicka.dev/docosaurus-test/blog/test-eks-post#prepare-the-local-working-environment">​</a></h2>
<p>::: tip
You can skip these steps if you have all the required software already
installed.
:::</p>
<p>Install necessary software:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if command -v apt-get &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apt update -qq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DEBIAN_FRONTEND=noninteractive apt-get install -y -qq apache2-utils ansible dnsutils git gnupg2 jq sudo unzip &gt; /dev/null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install <a href="https://aws.amazon.com/cli/" target="_blank" rel="noopener noreferrer">AWS CLI</a>  binary:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if ! command -v aws &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  curl -sL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unzip -q -o /tmp/awscliv2.zip -d /tmp/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo /tmp/aws/install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install <a href="https://github.com/kubernetes/kubectl" target="_blank" rel="noopener noreferrer">kubectl</a> binary:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if ! command -v kubectl &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # https://github.com/kubernetes/kubectl/releases</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo curl -s -Lo /usr/local/bin/kubectl "https://storage.googleapis.com/kubernetes-release/release/v1.21.1/bin/$(uname | sed "s/./\L&amp;/g")/amd64/kubectl"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo chmod a+x /usr/local/bin/kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install <a href="https://helm.sh/" target="_blank" rel="noopener noreferrer">Helm</a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if ! command -v helm &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # https://github.com/helm/helm/releases</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  curl -s https://raw.githubusercontent.com/helm/helm/master/scripts/get | bash -s -- --version v3.6.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install <a href="https://eksctl.io/" target="_blank" rel="noopener noreferrer">eksctl</a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if ! command -v eksctl &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # https://github.com/weaveworks/eksctl/releases</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  curl -s -L "https://github.com/weaveworks/eksctl/releases/download/0.60.0/eksctl_$(uname)_amd64.tar.gz" | sudo tar xz -C /usr/local/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install <a href="https://github.com/kubernetes-sigs/aws-iam-authenticator" target="_blank" rel="noopener noreferrer">AWS IAM Authenticator for Kubernetes</a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if ! command -v aws-iam-authenticator &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # https://docs.aws.amazon.com/eks/latest/userguide/install-aws-iam-authenticator.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo curl -s -Lo /usr/local/bin/aws-iam-authenticator "https://amazon-eks.s3.us-west-2.amazonaws.com/1.19.6/2021-01-05/bin/$(uname | sed "s/./\L&amp;/g")/amd64/aws-iam-authenticator"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo chmod a+x /usr/local/bin/aws-iam-authenticator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install <a href="https://www.vaultproject.io/downloads" target="_blank" rel="noopener noreferrer">vault</a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if ! command -v vault &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  curl -s -L "https://releases.hashicorp.com/vault/1.7.2/vault_1.7.2_$(uname | sed "s/./\L&amp;/g")_amd64.zip" -o /tmp/vault.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo unzip -q /tmp/vault.zip -d /usr/local/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rm /tmp/vault.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install <a href="https://github.com/vmware-tanzu/velero/releases" target="_blank" rel="noopener noreferrer">velero</a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if ! command -v velero &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  curl -s -L "https://github.com/vmware-tanzu/velero/releases/download/v1.6.0/velero-v1.6.0-$(uname | sed "s/./\L&amp;/g")-amd64.tar.gz" -o /tmp/velero.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo tar xzf /tmp/velero.tar.gz -C /usr/local/bin/ --strip-components 1 "velero-v1.6.0-$(uname | sed "s/./\L&amp;/g")-amd64/velero"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install <a href="https://toolkit.fluxcd.io/" target="_blank" rel="noopener noreferrer">flux</a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if ! command -v flux &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  curl -s https://fluxcd.io/install.sh | sudo bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install <code>calicoctl</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if ! command -v calicoctl &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo curl -s -Lo /usr/local/bin/calicoctl https://github.com/projectcalico/calicoctl/releases/download/v3.20.0/calicoctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo chmod a+x /usr/local/bin/calicoctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install <a href="https://github.com/mozilla/sops" target="_blank" rel="noopener noreferrer">SOPS: Secrets OPerationS</a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if ! command -v sops &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo curl -s -Lo /usr/local/bin/sops "https://github.com/mozilla/sops/releases/download/v3.7.1/sops-v3.7.1.$(uname | sed "s/./\L&amp;/g")"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo chmod a+x /usr/local/bin/sops</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install <a href="https://kustomize.io/" target="_blank" rel="noopener noreferrer">kustomize</a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if ! command -v kustomize &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | sudo bash -s 4.1.2 /usr/local/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install <a href="https://github.com/rakyll/hey" target="_blank" rel="noopener noreferrer">hey</a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if ! command -v hey &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo curl -s -Lo /usr/local/bin/hey "https://hey-release.s3.us-east-2.amazonaws.com/hey_$(uname | sed "s/./\L&amp;/g")_amd64"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo chmod a+x /usr/local/bin/hey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="configure-aws-route-53-domain-delegation">Configure AWS Route 53 Domain delegation<a class="hash-link" aria-label="Direct link to Configure AWS Route 53 Domain delegation" title="Direct link to Configure AWS Route 53 Domain delegation" href="https://blog-test.ruzicka.dev/docosaurus-test/blog/test-eks-post#configure-aws-route-53-domain-delegation">​</a></h2>
<p>Create DNS zone (<code>BASE_DOMAIN</code>):</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws route53 create-hosted-zone --output json \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --name "${BASE_DOMAIN}" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --caller-reference "$(date)" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --hosted-zone-config="{\"Comment\": \"Created by ${MY_EMAIL}\", \"PrivateZone\": false}" | jq</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Use your domain registrar to change the nameservers for your zone (for example
"mylabs.dev") to use the Amazon Route 53 nameservers. Here is the way how you
can find out the the Route 53 nameservers:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NEW_ZONE_ID=$(aws route53 list-hosted-zones --query "HostedZones[?Name==\`${BASE_DOMAIN}.\`].Id" --output text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NEW_ZONE_NS=$(aws route53 get-hosted-zone --output json --id "${NEW_ZONE_ID}" --query "DelegationSet.NameServers")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NEW_ZONE_NS1=$(echo "${NEW_ZONE_NS}" | jq -r ".[0]")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NEW_ZONE_NS2=$(echo "${NEW_ZONE_NS}" | jq -r ".[1]")</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Create the NS record in <code>k8s.mylabs.dev</code> (<code>BASE_DOMAIN</code>) for proper zone
delegation. This step depends on your domain registrar - I'm using CloudFlare
and using Ansible to automate it:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ansible -m cloudflare_dns -c local -i "localhost," localhost -a "zone=mylabs.dev record=${BASE_DOMAIN} type=NS value=${NEW_ZONE_NS1} solo=true proxied=no account_email=${CLOUDFLARE_EMAIL} account_api_token=${CLOUDFLARE_API_KEY}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ansible -m cloudflare_dns -c local -i "localhost," localhost -a "zone=mylabs.dev record=${BASE_DOMAIN} type=NS value=${NEW_ZONE_NS2} solo=false proxied=no account_email=${CLOUDFLARE_EMAIL} account_api_token=${CLOUDFLARE_API_KEY}"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Output:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">localhost | CHANGED =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "ansible_facts": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "discovered_interpreter_python": "/usr/bin/python"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "changed": true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "result": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "record": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "content": "ns-885.awsdns-46.net",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "created_on": "2020-11-13T06:25:32.18642Z",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "id": "dxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxb",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "locked": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "meta": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "auto_added": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "managed_by_apps": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "managed_by_argo_tunnel": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "source": "primary"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "modified_on": "2020-11-13T06:25:32.18642Z",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "name": "k8s.mylabs.dev",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "proxiable": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "proxied": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "ttl": 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "type": "NS",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "zone_id": "2xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxe",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "zone_name": "mylabs.dev"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">localhost | CHANGED =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "ansible_facts": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "discovered_interpreter_python": "/usr/bin/python"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "changed": true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "result": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "record": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "content": "ns-1692.awsdns-19.co.uk",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "created_on": "2020-11-13T06:25:37.605605Z",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "id": "9xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxb",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "locked": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "meta": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "auto_added": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "managed_by_apps": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "managed_by_argo_tunnel": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "source": "primary"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "modified_on": "2020-11-13T06:25:37.605605Z",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "name": "k8s.mylabs.dev",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "proxiable": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "proxied": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "ttl": 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "type": "NS",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "zone_id": "2xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxe",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "zone_name": "mylabs.dev"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="add-new-domain-to-route-53-policies-s3-ebs">Add new domain to Route 53, Policies, S3, EBS<a class="hash-link" aria-label="Direct link to Add new domain to Route 53, Policies, S3, EBS" title="Direct link to Add new domain to Route 53, Policies, S3, EBS" href="https://blog-test.ruzicka.dev/docosaurus-test/blog/test-eks-post#add-new-domain-to-route-53-policies-s3-ebs">​</a></h2>
<p>Details with examples are described on these links:</p>
<ul>
<li><a href="https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/" target="_blank" rel="noopener noreferrer">https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/</a></li>
<li><a href="https://cert-manager.io/docs/configuration/acme/dns01/route53/" target="_blank" rel="noopener noreferrer">https://cert-manager.io/docs/configuration/acme/dns01/route53/</a></li>
<li><a href="https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/aws.md" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/aws.md</a></li>
</ul>
<p>Create CloudFormation template containing policies for Route53, S3 access
(Harbor, Velero) and Domain. Put new domain <code>CLUSTER_FQDN</code> to the Route 53 and
configure the DNS delegation from the <code>BASE_DOMAIN</code>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -vp "tmp/${CLUSTER_FQDN}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; "tmp/${CLUSTER_FQDN}/aws-route53-iam-s3-kms-asm.yml" &lt;&lt; \EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description: "Template to generate the necessary IAM Policies for access to Route53 and S3"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClusterFQDN:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Description: "Cluster domain where all necessary app subdomains will live (subdomain of BaseDomain). Ex: kube1.k8s.mylabs.dev"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClusterName:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Description: "Cluster Name Ex: kube1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  BaseDomain:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Description: "Base domain where cluster domains + their subdomains will live. Ex: k8s.mylabs.dev"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # This AWS control checks whether the status of the AWS Systems Manager association compliance is COMPLIANT or NON_COMPLIANT after the association is executed on an instance.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ConfigRule:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: "AWS::Config::ConfigRule"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ConfigRuleName: !Sub "${ClusterName}-ec2-managedinstance-association-compliance-status-check"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Scope:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ComplianceResourceTypes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - "AWS::SSM::AssociationCompliance"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Description: "A Config rule that checks whether the compliance status of the Amazon EC2 Systems Manager association compliance is COMPLIANT or NON_COMPLIANT after the association execution on the instance. The rule is compliant if the field status is COMPLIANT."</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Source:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Owner: "AWS"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SourceIdentifier: "EC2_MANAGEDINSTANCE_ASSOCIATION_COMPLIANCE_STATUS_CHECK"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CloudWatchPolicy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::IAM::ManagedPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ManagedPolicyName: !Sub "${ClusterFQDN}-CloudWatch"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Description: !Sub "Policy required by Fargate to log to CloudWatch for ${ClusterFQDN}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      PolicyDocument:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Version: "2012-10-17"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Statement:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Action:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - logs:CreateLogStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - logs:CreateLogGroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - logs:DescribeLogStreams</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - logs:PutLogEvents</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Resource: "*"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  HostedZone:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::Route53::HostedZone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name: !Ref ClusterFQDN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KMSAlias:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::KMS::Alias</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AliasName: !Sub "alias/eks-${ClusterName}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      TargetKeyId: !Ref KMSKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KMSKey:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::KMS::Key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Description: !Sub "KMS key for secrets related to ${ClusterFQDN}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      EnableKeyRotation: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      PendingWindowInDays: 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      KeyPolicy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Version: "2012-10-17"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Id: !Sub "eks-key-policy-${ClusterName}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Statement:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Sid: Enable IAM User Permissions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Principal:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Action: kms:*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Resource: "*"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Sid: Allow use of the key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Principal:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AWS: !Sub "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/autoscaling.amazonaws.com/AWSServiceRoleForAutoScaling"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Action:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - kms:Encrypt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - kms:Decrypt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - kms:ReEncrypt*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - kms:GenerateDataKey*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - kms:DescribeKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Resource: "*"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Sid: Allow attachment of persistent resources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Principal:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AWS: !Sub "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/autoscaling.amazonaws.com/AWSServiceRoleForAutoScaling"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Action:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - kms:CreateGrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Resource: "*"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Condition:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Bool:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              kms:GrantIsForAWSResource: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  EKSViewNodesAndWorkloadsPolicy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::IAM::ManagedPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ManagedPolicyName: !Sub "${ClusterFQDN}-EKSViewNodesAndWorkloads"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Description: !Sub "Policy used to view workloads running in an EKS cluster created using CAPA"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      PolicyDocument:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Version: "2012-10-17"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Statement:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Action:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - eks:DescribeNodegroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - eks:ListNodegroups</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - eks:DescribeCluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - eks:ListClusters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - eks:AccessKubernetesApi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - ssm:GetParameter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - eks:ListUpdates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - eks:ListFargateProfiles</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Resource: "*"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RecordSet:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::Route53::RecordSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      HostedZoneName: !Sub "${BaseDomain}."</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name: !Ref ClusterFQDN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Type: NS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      TTL: 60</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ResourceRecords: !GetAtt HostedZone.NameServers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  S3Policy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::IAM::ManagedPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ManagedPolicyName: !Sub "${ClusterFQDN}-AmazonS3"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Description: !Sub "Policy required by Harbor and Velero to write to S3 bucket ${ClusterFQDN}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      PolicyDocument:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Version: "2012-10-17"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Statement:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Action:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - s3:ListBucket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - s3:GetBucketLocation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - s3:ListBucketMultipartUploads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Resource: !GetAtt S3Bucket.Arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Action:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - s3:PutObject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - s3:GetObject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - s3:DeleteObject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - s3:ListMultipartUploadParts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - s3:AbortMultipartUpload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Resource: !Sub "arn:aws:s3:::${ClusterFQDN}/*"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  S3Bucket:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::S3::Bucket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AccessControl: Private</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      BucketName: !Sub "${ClusterFQDN}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      BucketEncryption:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerSideEncryptionConfiguration:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - ServerSideEncryptionByDefault:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              SSEAlgorithm: AES256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SecretsManagerMySecret:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::SecretsManager::Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name: !Sub "${ClusterFQDN}-MySecret"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Description: My Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      GenerateSecretString:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SecretStringTemplate: "{\"username\": \"Administrator\"}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GenerateStringKey: password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PasswordLength: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      KmsKeyId: !Ref KMSKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SecretsManagerMySecret2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::SecretsManager::Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name: !Sub "${ClusterFQDN}-MySecret2"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Description: My Secret2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      GenerateSecretString:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SecretStringTemplate: "{\"username\": \"Administrator2\"}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GenerateStringKey: password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PasswordLength: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      KmsKeyId: !Ref KMSKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UserMyUser1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::IAM::User</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      UserName: !Sub "myuser1-${ClusterName}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Policies:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - PolicyName: !Sub "myuser1-${ClusterName}-policy"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PolicyDocument:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Version: "2012-10-17"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Statement:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - Sid: AllowAssumeOrganizationAccountRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Action: sts:AssumeRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Resource: !GetAtt RoleMyUser1.Arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AccessKeyMyUser1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::IAM::AccessKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      UserName: !Ref UserMyUser1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RoleMyUser1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::IAM::Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Description: !Sub "IAM role for the myuser1-${ClusterName} user"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      RoleName: !Sub "myuser1-${ClusterName}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AssumeRolePolicyDocument:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Version: 2012-10-17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Statement:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Principal:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Action: sts:AssumeRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UserMyUser2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::IAM::User</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      UserName: !Sub "myuser2-${ClusterName}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Policies:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - PolicyName: !Sub "myuser2-${ClusterName}-policy"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PolicyDocument:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Version: "2012-10-17"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Statement:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - Sid: AllowAssumeOrganizationAccountRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Action: sts:AssumeRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Resource: !GetAtt RoleMyUser2.Arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AccessKeyMyUser2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::IAM::AccessKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      UserName: !Ref UserMyUser2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RoleMyUser2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: AWS::IAM::Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Description: !Sub "IAM role for the myuser2-${ClusterName} user"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      RoleName: !Sub "myuser2-${ClusterName}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AssumeRolePolicyDocument:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Version: 2012-10-17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Statement:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Principal:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Action: sts:AssumeRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Outputs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CloudWatchPolicyArn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Description: The ARN of the created CloudWatchPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Value: !Ref CloudWatchPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Export:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Fn::Sub: "${AWS::StackName}-CloudWatchPolicyArn"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KMSKeyArn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Description: The ARN of the created KMS Key to encrypt EKS related services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Value: !GetAtt KMSKey.Arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Export:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Fn::Sub: "${AWS::StackName}-KMSKeyArn"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KMSKeyId:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Description: The ID of the created KMS Key to encrypt EKS related services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Value: !Ref KMSKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Export:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Fn::Sub: "${AWS::StackName}-KMSKeyId"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  HostedZoneArn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Description: The ARN of the created Route53 Zone for K8s cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Value: !Ref HostedZone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Export:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Fn::Sub: "${AWS::StackName}-HostedZoneArn"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  S3PolicyArn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Description: The ARN of the created AmazonS3 policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Value: !Ref S3Policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Export:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Fn::Sub: "${AWS::StackName}-S3PolicyArn"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RoleMyUser1Arn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Description: The ARN of the MyUser1 IAM Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Value: !GetAtt RoleMyUser1.Arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Export:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Fn::Sub: "${AWS::StackName}-RoleMyUser1Arn"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AccessKeyMyUser1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Description: The AccessKey for MyUser1 user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Value: !Ref AccessKeyMyUser1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Export:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Fn::Sub: "${AWS::StackName}-AccessKeyMyUser1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SecretAccessKeyMyUser1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Description: The SecretAccessKey for MyUser1 user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Value: !GetAtt AccessKeyMyUser1.SecretAccessKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Export:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Fn::Sub: "${AWS::StackName}-SecretAccessKeyMyUser1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RoleMyUser2Arn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Description: The ARN of the MyUser2 IAM Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Value: !GetAtt RoleMyUser2.Arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Export:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Fn::Sub: "${AWS::StackName}-RoleMyUser2Arn"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AccessKeyMyUser2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Description: The AccessKey for MyUser2 user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Value: !Ref AccessKeyMyUser2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Export:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Fn::Sub: "${AWS::StackName}-AccessKeyMyUser2"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SecretAccessKeyMyUser2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Description: The SecretAccessKey for MyUser2 user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Value: !GetAtt AccessKeyMyUser2.SecretAccessKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Export:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Fn::Sub: "${AWS::StackName}-SecretAccessKeyMyUser2"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eval aws cloudformation deploy --capabilities CAPABILITY_NAMED_IAM \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --parameter-overrides "ClusterFQDN=${CLUSTER_FQDN} ClusterName=${CLUSTER_NAME} BaseDomain=${BASE_DOMAIN}" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --stack-name "${CLUSTER_NAME}-route53-iam-s3-kms-asm" --template-file "tmp/${CLUSTER_FQDN}/aws-route53-iam-s3-kms-asm.yml" --tags "${TAGS}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AWS_CLOUDFORMATION_DETAILS=$(aws cloudformation describe-stacks --stack-name "${CLUSTER_NAME}-route53-iam-s3-kms-asm")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># CLOUDWATCH_POLICY_ARN=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"CloudWatchPolicyArn\") .OutputValue")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KMS_KEY_ARN=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"KMSKeyArn\") .OutputValue")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KMS_KEY_ID=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"KMSKeyId\") .OutputValue")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">S3_POLICY_ARN=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"S3PolicyArn\") .OutputValue")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># MYUSER1_ROLE_ARN=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"RoleMyUser1Arn\") .OutputValue")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># MYUSER1_USER_ACCESSKEYMYUSER=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"AccessKeyMyUser1\") .OutputValue")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># MYUSER1_USER_SECRETACCESSKEY=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"SecretAccessKeyMyUser1\") .OutputValue")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># MYUSER2_ROLE_ARN=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"RoleMyUser2Arn\") .OutputValue")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># MYUSER2_USER_ACCESSKEYMYUSER=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"AccessKeyMyUser2\") .OutputValue")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># MYUSER2_USER_SECRETACCESSKEY=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"SecretAccessKeyMyUser2\") .OutputValue")</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Change TTL=60 of SOA + NS records for new domain
(it can not be done in CloudFormation):</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HOSTED_ZONE_ID=$(aws route53 list-hosted-zones --query "HostedZones[?Name==\`${CLUSTER_FQDN}.\`].Id" --output text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESOURCE_RECORD_SET_SOA=$(aws route53 --output json list-resource-record-sets --hosted-zone-id "${HOSTED_ZONE_ID}" --query "(ResourceRecordSets[?Type == \`SOA\`])[0]" | sed "s/\"TTL\":.*/\"TTL\": 60,/")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESOURCE_RECORD_SET_NS=$(aws route53 --output json list-resource-record-sets --hosted-zone-id "${HOSTED_ZONE_ID}" --query "(ResourceRecordSets[?Type == \`NS\`])[0]" | sed "s/\"TTL\":.*/\"TTL\": 60,/")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt; EOF | aws route53 --output json change-resource-record-sets --hosted-zone-id "${HOSTED_ZONE_ID}" --change-batch=file:///dev/stdin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "Comment": "Update record to reflect new TTL for SOA and NS records",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "Changes": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "Action": "UPSERT",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "ResourceRecordSet":</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">${RESOURCE_RECORD_SET_SOA}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "Action": "UPSERT",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "ResourceRecordSet":</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">${RESOURCE_RECORD_SET_NS}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="create-amazon-eks">Create Amazon EKS<a class="hash-link" aria-label="Direct link to Create Amazon EKS" title="Direct link to Create Amazon EKS" href="https://blog-test.ruzicka.dev/docosaurus-test/blog/test-eks-post#create-amazon-eks">​</a></h2>
<p><img decoding="async" loading="lazy" src="https://raw.githubusercontent.com/aws-samples/eks-workshop/65b766c494a5b4f5420b2912d8373c4957163541/static/images/3-service-animated.gif" alt="EKS" title="EKS" class="img_ev3q"></p>
<p>Create <a href="https://aws.amazon.com/eks/" target="_blank" rel="noopener noreferrer">Amazon EKS</a> in AWS by using <a href="https://eksctl.io/" target="_blank" rel="noopener noreferrer">eksctl</a>.
It's a tool from Weaveworks based on official
AWS CloudFormation templates which will be used to launch and configure our
EKS cluster and nodes.</p>
<p><img decoding="async" loading="lazy" src="https://raw.githubusercontent.com/weaveworks/eksctl/c365149fc1a0b8d357139cbd6cda5aee8841c16c/logo/eksctl.png" alt="eksctl" title="eksctl" class="img_ev3q"></p>
<p>Generate SSH key if not exists:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test -f ~/.ssh/id_rsa.pub || (install -m 0700 -d ~/.ssh &amp;&amp; ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa -q -N "")</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Create the Amazon EKS cluster with Calico using <code>eksctl</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; "tmp/${CLUSTER_FQDN}/eksctl.yaml" &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: eksctl.io/v1alpha5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ClusterConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: ${CLUSTER_NAME}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region: ${AWS_DEFAULT_REGION}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version: "1.21"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags: &amp;tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$(echo "${TAGS}" | sed "s/ /\\n    /g; s/^/    /g; s/=/: /g")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">availabilityZones:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - ${AWS_DEFAULT_REGION}a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - ${AWS_DEFAULT_REGION}b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iam:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  withOIDC: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceAccounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: aws-load-balancer-controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      wellKnownPolicies:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        awsLoadBalancerController: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: cert-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        namespace: cert-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      wellKnownPolicies:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        certManager: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: cluster-autoscaler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      wellKnownPolicies:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        autoScaler: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: external-dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        namespace: external-dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      wellKnownPolicies:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        externalDNS: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: ebs-csi-controller-sa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      wellKnownPolicies:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ebsCSIController: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: harbor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        namespace: harbor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      attachPolicyARNs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - ${S3_POLICY_ARN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: velero</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        namespace: velero</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      attachPolicyARNs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - ${S3_POLICY_ARN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: s3-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        namespace: s3-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      attachPolicyARNs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - ${S3_POLICY_ARN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        namespace: kube-prometheus-stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      attachPolicyARNs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - arn:aws:iam::aws:policy/AmazonPrometheusQueryAccess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      attachPolicy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Version: 2012-10-17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Statement:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Sid: AllowReadingTagsInstancesRegionsFromEC2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Action:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - ec2:DescribeTags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - ec2:DescribeInstances</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - ec2:DescribeRegions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Resource: "*"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Sid: AllowReadingResourcesForTags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Action: tag:GetResources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Resource: "*"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: kube-prometheus-stack-prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        namespace: kube-prometheus-stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      attachPolicyARNs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - arn:aws:iam::aws:policy/AmazonPrometheusQueryAccess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - arn:aws:iam::aws:policy/AmazonPrometheusRemoteWriteAccess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: efs-csi-controller-sa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      wellKnownPolicies:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        efsCSIController: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        namespace: vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      attachPolicy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Version: 2012-10-17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Statement:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Sid: VaultKMSUnseal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Action:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - kms:Encrypt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - kms:Decrypt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - kms:DescribeKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Resource:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - "${KMS_KEY_ARN}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: kuard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        namespace: kuard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      attachPolicy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Version: 2012-10-17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Statement:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Sid: AllowSecretManagerAccess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Action:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - secretsmanager:GetSecretValue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - secretsmanager:DescribeSecret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Resource:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - "arn:aws:secretsmanager:*:*:secret:*"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Sid: AllowKMSAccess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Effect: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Action:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - kms:Decrypt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Resource:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - "${KMS_KEY_ARN}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vpc:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nat:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gateway: Disable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">managedNodeGroups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: managed-ng-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    amiFamily: Bottlerocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instanceType: t3.xlarge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instancePrefix: ruzickap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    desiredCapacity: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    minSize: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    maxSize: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumeSize: 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      role: worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tags: *tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iam:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      withAddonPolicies:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        autoScaler: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cloudWatch: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ebs: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        efs: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    maxPodsPerNode: 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumeEncrypted: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumeKmsKeyID: ${KMS_KEY_ID}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fargateProfiles:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: fp-fgtest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectors:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - namespace: fgtest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tags: *tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">secretsEncryption:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  keyARN: ${KMS_KEY_ARN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cloudWatch:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clusterLogging:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enableTypes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - authenticator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ! eksctl get clusters --name="${CLUSTER_NAME}" &amp;&gt; /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eksctl create cluster --config-file "tmp/${CLUSTER_FQDN}/eksctl.yaml" --kubeconfig "${KUBECONFIG}" --without-nodegroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubectl delete daemonset -n kube-system aws-node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubectl apply -f https://docs.projectcalico.org/archive/v3.20/manifests/calico-vxlan.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eksctl create nodegroup --config-file "tmp/${CLUSTER_FQDN}/eksctl.yaml"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Output:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 17:52:50 [ℹ]  eksctl version 0.75.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 17:52:50 [ℹ]  using region eu-west-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 17:52:50 [ℹ]  subnets for eu-west-1a - public:192.168.0.0/19 private:192.168.64.0/19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 17:52:50 [ℹ]  subnets for eu-west-1b - public:192.168.32.0/19 private:192.168.96.0/19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 17:52:50 [ℹ]  using Kubernetes version 1.21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 17:52:50 [ℹ]  creating EKS cluster "kube1" in "eu-west-1" region with Fargate profile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 17:52:50 [ℹ]  will create a CloudFormation stack for cluster itself and 0 nodegroup stack(s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 17:52:50 [ℹ]  will create a CloudFormation stack for cluster itself and 0 managed nodegroup stack(s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 17:52:50 [ℹ]  if you encounter any issues, check CloudFormation console or try 'eksctl utils describe-stacks --region=eu-west-1 --cluster=kube1'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 17:52:50 [ℹ]  Kubernetes API endpoint access will use default of {publicAccess=true, privateAccess=false} for cluster "kube1" in "eu-west-1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 17:52:50 [ℹ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2 sequential tasks: { create cluster control plane "kube1",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    7 sequential sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        wait for control plane to become ready,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tag cluster,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        update CloudWatch logging configuration,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create fargate profiles,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        associate IAM OIDC provider,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        14 parallel sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2 sequential sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create IAM role for serviceaccount "kube-system/aws-load-balancer-controller",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create serviceaccount "kube-system/aws-load-balancer-controller",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2 sequential sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create IAM role for serviceaccount "cert-manager/cert-manager",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create serviceaccount "cert-manager/cert-manager",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2 sequential sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create IAM role for serviceaccount "kube-system/cluster-autoscaler",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create serviceaccount "kube-system/cluster-autoscaler",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2 sequential sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create IAM role for serviceaccount "external-dns/external-dns",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create serviceaccount "external-dns/external-dns",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2 sequential sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create IAM role for serviceaccount "kube-system/ebs-csi-controller-sa",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create serviceaccount "kube-system/ebs-csi-controller-sa",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2 sequential sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create IAM role for serviceaccount "harbor/harbor",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create serviceaccount "harbor/harbor",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2 sequential sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create IAM role for serviceaccount "velero/velero",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create serviceaccount "velero/velero",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2 sequential sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create IAM role for serviceaccount "s3-test/s3-test",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create serviceaccount "s3-test/s3-test",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2 sequential sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create IAM role for serviceaccount "kube-prometheus-stack/grafana",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create serviceaccount "kube-prometheus-stack/grafana",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2 sequential sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create IAM role for serviceaccount "kube-prometheus-stack/kube-prometheus-stack-prometheus",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create serviceaccount "kube-prometheus-stack/kube-prometheus-stack-prometheus",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2 sequential sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create IAM role for serviceaccount "kube-system/efs-csi-controller-sa",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create serviceaccount "kube-system/efs-csi-controller-sa",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2 sequential sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create IAM role for serviceaccount "vault/vault",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create serviceaccount "vault/vault",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2 sequential sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create IAM role for serviceaccount "kuard/kuard",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create serviceaccount "kuard/kuard",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2 sequential sub-tasks: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create IAM role for serviceaccount "kube-system/aws-node",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                create serviceaccount "kube-system/aws-node",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        restart daemonset "kube-system/aws-node",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 17:52:50 [ℹ]  building cluster stack "eksctl-kube1-cluster"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 17:52:50 [ℹ]  deploying stack "eksctl-kube1-cluster"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 17:53:21 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-cluster"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:05:55 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-cluster"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:07:59 [✔]  tagged EKS cluster (Owner=petr.ruzicka@gmail.com, Squad=Cloud_Container_Platform, compliance:na:defender=bottlerocket, Environment=Dev, Group=Cloud_Native)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:08:00 [ℹ]  waiting for requested "LoggingUpdate" in cluster "kube1" to succeed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:08:53 [ℹ]  waiting for requested "LoggingUpdate" in cluster "kube1" to succeed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:08:54 [✔]  configured CloudWatch logging for cluster "kube1" in "eu-west-1" (enabled types: authenticator &amp; disabled types: api, audit, controllerManager, scheduler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:08:54 [ℹ]  creating Fargate profile "fp-fgtest" on EKS cluster "kube1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:13:12 [ℹ]  created Fargate profile "fp-fgtest" on EKS cluster "kube1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-velero-velero"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-node"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-kube-prometheus-stack-prometheus"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-s3-test-s3-test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-harbor-harbor"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-harbor-harbor"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-harbor-harbor"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-s3-test-s3-test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-s3-test-s3-test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-velero-velero"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-velero-velero"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-kube-prometheus-stack-prometheus"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-kube-prometheus-stack-prometheus"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-node"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-node"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:00 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:00 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:01 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-velero-velero"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:02 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:02 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-harbor-harbor"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:02 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-s3-test-s3-test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:02 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:03 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:03 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:03 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:04 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:04 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-node"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:04 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-kube-prometheus-stack-prometheus"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:05 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:17 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-harbor-harbor"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:18 [ℹ]  created namespace "harbor"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:18 [ℹ]  created serviceaccount "harbor/harbor"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:18 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-s3-test-s3-test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:18 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:18 [ℹ]  created namespace "s3-test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:18 [ℹ]  created serviceaccount "s3-test/s3-test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:19 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-velero-velero"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:19 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:19 [ℹ]  created namespace "velero"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:19 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:20 [ℹ]  created serviceaccount "velero/velero"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:20 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:20 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:21 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-kube-prometheus-stack-prometheus"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:21 [ℹ]  created namespace "kube-prometheus-stack"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:21 [ℹ]  created serviceaccount "kube-prometheus-stack/kube-prometheus-stack-prometheus"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:21 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:21 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:24 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:24 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:24 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-node"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:24 [ℹ]  serviceaccount "kube-system/aws-node" already exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:24 [ℹ]  updated serviceaccount "kube-system/aws-node"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:35 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:36 [ℹ]  created serviceaccount "kube-system/cluster-autoscaler"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:37 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:38 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:38 [ℹ]  created serviceaccount "kube-prometheus-stack/grafana"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:38 [ℹ]  created namespace "kuard"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:38 [ℹ]  created serviceaccount "kuard/kuard"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:38 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:38 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:38 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:38 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:38 [ℹ]  created namespace "vault"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:39 [ℹ]  created serviceaccount "vault/vault"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:39 [ℹ]  created namespace "cert-manager"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:39 [ℹ]  created serviceaccount "cert-manager/cert-manager"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:39 [ℹ]  created serviceaccount "kube-system/aws-load-balancer-controller"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:39 [ℹ]  created serviceaccount "kube-system/ebs-csi-controller-sa"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:41 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:42 [ℹ]  created namespace "external-dns"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:42 [ℹ]  created serviceaccount "external-dns/external-dns"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:42 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:43 [ℹ]  created serviceaccount "kube-system/efs-csi-controller-sa"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:43 [ℹ]  daemonset "kube-system/aws-node" restarted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:43 [ℹ]  waiting for the control plane availability...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:43 [✔]  saved kubeconfig as "/Users/ruzickap/git/k8s-eks-bottlerocket-fargate/kubeconfig-kube1.conf"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:43 [ℹ]  no tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:43 [✔]  all EKS cluster resources for "kube1" have been created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:44 [ℹ]  kubectl command should work with "/Users/ruzickap/git/k8s-eks-bottlerocket-fargate/kubeconfig-kube1.conf", try 'kubectl --kubeconfig=/Users/ruzickap/git/k8s-eks-bottlerocket-fargate/kubeconfig-kube1.conf get nodes'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:44 [✔]  EKS cluster "kube1" in "eu-west-1" region is ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.apps "aws-node" deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap/calico-config created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/calico-node created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io/calico-node created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.apps/calico-node created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount/calico-node created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/calico-kube-controllers created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount/calico-kube-controllers created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: policy/v1beta1 PodDisruptionBudget is deprecated in v1.21+, unavailable in v1.25+; use policy/v1 PodDisruptionBudget</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">poddisruptionbudget.policy/calico-kube-controllers created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:59 [ℹ]  eksctl version 0.75.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:18:59 [ℹ]  using region eu-west-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:19:15 [ℹ]  nodegroup "managed-ng-1" will use "" [Bottlerocket/1.21]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:19:32 [ℹ]  1 nodegroup (managed-ng-1) was included (based on the include/exclude rules)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:19:32 [ℹ]  will create a CloudFormation stack for each of 1 managed nodegroups in cluster "kube1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:19:32 [ℹ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2 sequential tasks: { fix cluster compatibility, 1 task: { 1 task: { create managed nodegroup "managed-ng-1" } }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:19:32 [ℹ]  checking cluster stack for missing resources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:19:41 [ℹ]  cluster stack has all required resources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:19:41 [ℹ]  building managed nodegroup stack "eksctl-kube1-nodegroup-managed-ng-1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:19:41 [ℹ]  deploying stack "eksctl-kube1-nodegroup-managed-ng-1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:19:41 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-nodegroup-managed-ng-1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:22:59 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-nodegroup-managed-ng-1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:00 [ℹ]  no tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:00 [✔]  created 0 nodegroup(s) in cluster "kube1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:00 [ℹ]  nodegroup "managed-ng-1" has 3 node(s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:00 [ℹ]  node "ip-192-168-31-11.eu-west-1.compute.internal" is ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:00 [ℹ]  node "ip-192-168-56-82.eu-west-1.compute.internal" is ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:00 [ℹ]  node "ip-192-168-60-184.eu-west-1.compute.internal" is ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:00 [ℹ]  waiting for at least 2 node(s) to become ready in "managed-ng-1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:00 [ℹ]  nodegroup "managed-ng-1" has 3 node(s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:00 [ℹ]  node "ip-192-168-31-11.eu-west-1.compute.internal" is ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:00 [ℹ]  node "ip-192-168-56-82.eu-west-1.compute.internal" is ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:00 [ℹ]  node "ip-192-168-60-184.eu-west-1.compute.internal" is ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:00 [✔]  created 1 managed nodegroup(s) in cluster "kube1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:12 [ℹ]  checking security group configuration for all nodegroups</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:12 [ℹ]  all nodegroups have up-to-date cloudformation templates</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When the cluster is ready it immediately start pushing logs to CloudWatch under
<code>/aws/eks/kube1/cluster</code>.</p>
<p>Add add the user or role to the aws-auth ConfigMap. This is handy if you are
using different user for cli operations and different user/role for accessing
the AWS Console to see EKS Workloads in Cluster's tab.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if ! eksctl get iamidentitymapping --cluster="${CLUSTER_NAME}" --region="${AWS_DEFAULT_REGION}" --arn=${AWS_CONSOLE_ADMIN_ROLE_ARN}; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eksctl create iamidentitymapping --cluster="${CLUSTER_NAME}" --region="${AWS_DEFAULT_REGION}" --arn="${AWS_CONSOLE_ADMIN_ROLE_ARN}" --group system:masters --username admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Output:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:13 [ℹ]  eksctl version 0.75.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:13 [ℹ]  using region eu-west-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-29 18:23:14 [ℹ]  adding identity "arn:aws:iam::7xxxxxxxxxx7:role/AxxxxxxxxxxxxN" to auth ConfigMap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Check the nodes+pods and max number of nodes which can be scheduled on one node:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodes,pods -o wide --all-namespaces</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Output:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                STATUS   ROLES    AGE   VERSION   INTERNAL-IP      EXTERNAL-IP     OS-IMAGE                               KERNEL-VERSION   CONTAINER-RUNTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node/ip-192-168-31-11.eu-west-1.compute.internal    Ready    &lt;none&gt;   81s   v1.21.6   192.168.31.11    54.194.69.158   Bottlerocket OS 1.4.1 (aws-k8s-1.21)   5.10.68          containerd://1.5.5+bottlerocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node/ip-192-168-56-82.eu-west-1.compute.internal    Ready    &lt;none&gt;   86s   v1.21.6   192.168.56.82    3.250.52.238    Bottlerocket OS 1.4.1 (aws-k8s-1.21)   5.10.68          containerd://1.5.5+bottlerocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node/ip-192-168-60-184.eu-west-1.compute.internal   Ready    &lt;none&gt;   84s   v1.21.6   192.168.60.184   54.75.89.58     Bottlerocket OS 1.4.1 (aws-k8s-1.21)   5.10.68          containerd://1.5.5+bottlerocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE     NAME                                           READY   STATUS    RESTARTS   AGE     IP               NODE                                           NOMINATED NODE   READINESS GATES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   pod/calico-kube-controllers-6c85b56fcb-5g5cq   1/1     Running   0          4m16s   172.16.166.130   ip-192-168-56-82.eu-west-1.compute.internal    &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   pod/calico-node-4whs8                          1/1     Running   0          84s     192.168.60.184   ip-192-168-60-184.eu-west-1.compute.internal   &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   pod/calico-node-nbjsn                          1/1     Running   0          86s     192.168.56.82    ip-192-168-56-82.eu-west-1.compute.internal    &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   pod/calico-node-nnhwz                          1/1     Running   0          81s     192.168.31.11    ip-192-168-31-11.eu-west-1.compute.internal    &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   pod/coredns-7cc879f8db-ct5bp                   1/1     Running   0          21m     172.16.166.131   ip-192-168-56-82.eu-west-1.compute.internal    &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   pod/coredns-7cc879f8db-h4mbs                   1/1     Running   0          21m     172.16.166.129   ip-192-168-56-82.eu-west-1.compute.internal    &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   pod/kube-proxy-9c9wk                           1/1     Running   0          86s     192.168.56.82    ip-192-168-56-82.eu-west-1.compute.internal    &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   pod/kube-proxy-gqbt7                           1/1     Running   0          81s     192.168.31.11    ip-192-168-31-11.eu-west-1.compute.internal    &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   pod/kube-proxy-q7pzh                           1/1     Running   0          84s     192.168.60.184   ip-192-168-60-184.eu-west-1.compute.internal   &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>EKS</category>
            <category>Pipeline Templates</category>
        </item>
        <item>
            <title><![CDATA[Image Test EKS Post]]></title>
            <link>https://blog-test.ruzicka.dev/docosaurus-test/blog/image-test-eks-post</link>
            <guid>https://blog-test.ruzicka.dev/docosaurus-test/blog/image-test-eks-post</guid>
            <pubDate>Tue, 01 Dec 2020 00:00:00 GMT</pubDate>
            <description><![CDATA[Keycloak]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="keycloak">Keycloak<a class="hash-link" aria-label="Direct link to Keycloak" title="Direct link to Keycloak" href="https://blog-test.ruzicka.dev/docosaurus-test/blog/image-test-eks-post#keycloak">​</a></h2>
<p>Install <code>keycloak</code>
<a href="https://artifacthub.io/packages/helm/bitnami/keycloak" target="_blank" rel="noopener noreferrer">helm chart</a>
and modify the
<a href="https://github.com/bitnami/charts/blob/master/bitnami/keycloak/values.yaml" target="_blank" rel="noopener noreferrer">default values</a>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add --force-update bitnami https://charts.bitnami.com/bitnami</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm upgrade --install --version 5.0.6 --namespace keycloak --create-namespace --values - keycloak bitnami/keycloak &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterDomain: ${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auth:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  adminUser: admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  adminPassword: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  managementUser: admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  managementPassword: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proxyAddressForwarding: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># https://stackoverflow.com/questions/51616770/keycloak-restricting-user-management-to-certain-groups-while-enabling-manage-us</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extraStartupArgs: "-Dkeycloak.profile.feature.admin_fine_grained_authz=enabled"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># keycloakConfigCli:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   # Workaround for bug: https://github.com/bitnami/charts/issues/6823</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   image:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     repository: adorsys/keycloak-config-cli</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     tag: latest-15.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   configuration:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     myrealm.yaml: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       realm: myrealm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       displayName: My Realm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       rememberMe: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       userManagedAccessAllowed: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       smtpServer:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         from: myrealm-keycloak@${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         fromDisplayName: Keycloak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         host: mailhog.mailhog.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         port: 1025</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       clients:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       # https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/oauth_provider/#keycloak-auth-provider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       - clientId: oauth2-proxy-keycloak.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         name: oauth2-proxy-keycloak.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         description: "OAuth2 Proxy for Keycloak"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         secret: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         redirectUris:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         - "https://oauth2-proxy-keycloak.${CLUSTER_FQDN}/oauth2/callback"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         protocolMappers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         - name: groupMapper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           protocol: openid-connect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           protocolMapper: oidc-group-membership-mapper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#             userinfo.token.claim: "true"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#             id.token.claim: "true"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#             access.token.claim: "true"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#             claim.name: groups</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#             full.path: "true"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       identityProviders:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       # https://ultimatesecurity.pro/post/okta-oidc/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       - alias: keycloak-oidc-okta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         displayName: "Okta"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         providerId: keycloak-oidc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         trustEmail: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           clientId: ${OKTA_CLIENT_ID}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           clientSecret: ${OKTA_CLIENT_SECRET}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           tokenUrl: "${OKTA_ISSUER}/oauth2/default/v1/token"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           authorizationUrl: "${OKTA_ISSUER}/oauth2/default/v1/authorize"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           defaultScope: "openid profile email"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           syncMode: IMPORT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       - alias: dex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         displayName: "Dex"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         providerId: keycloak-oidc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         trustEmail: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           clientId: keycloak.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           clientSecret: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           tokenUrl: https://dex.${CLUSTER_FQDN}/token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           authorizationUrl: https://dex.${CLUSTER_FQDN}/auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           syncMode: IMPORT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       - alias: github</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         displayName: "Github"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         providerId: github</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         trustEmail: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           clientId: ${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           clientSecret: ${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       users:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       - username: myuser1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         email: myuser1@${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         firstName: My Firstname 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         lastName: My Lastname 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         groups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           - group-admins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         credentials:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         - type: password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           value: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       - username: myuser2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         email: myuser2@${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         firstName: My Firstname 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         lastName: My Lastname 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         groups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           - group-admins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         credentials:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         - type: password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           value: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       - username: myuser3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         email: myuser3@${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         firstName: My Firstname 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         lastName: My Lastname 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         groups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           - group-users</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         credentials:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         - type: password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           value: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       - username: myuser4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         email: myuser4@${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         firstName: My Firstname 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         lastName: My Lastname 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         groups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           - group-users</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           - group-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         credentials:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#         - type: password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#           value: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       groups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       - name: group-users</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       - name: group-admins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#       - name: group-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: ClusterIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hostname: keycloak.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  extraTls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - hosts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - keycloak.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secretName: ingress-cert-${LETSENCRYPT_ENVIRONMENT}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">networkPolicy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metrics:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceMonitor:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgresql:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  persistence:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="oauth2-proxy---keycloak">oauth2-proxy - Keycloak<a class="hash-link" aria-label="Direct link to oauth2-proxy - Keycloak" title="Direct link to oauth2-proxy - Keycloak" href="https://blog-test.ruzicka.dev/docosaurus-test/blog/image-test-eks-post#oauth2-proxy---keycloak">​</a></h2>
<p>Install <a href="https://github.com/oauth2-proxy/oauth2-proxy" target="_blank" rel="noopener noreferrer">oauth2-proxy</a> to secure
the endpoints like (<code>prometheus.</code>, <code>alertmanager.</code>).</p>
<p>Install <code>oauth2-proxy</code>
<a href="https://artifacthub.io/packages/helm/oauth2-proxy/oauth2-proxy" target="_blank" rel="noopener noreferrer">helm chart</a>
and modify the
<a href="https://github.com/oauth2-proxy/manifests/blob/main/helm/oauth2-proxy/values.yaml" target="_blank" rel="noopener noreferrer">default values</a>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add --force-update oauth2-proxy https://oauth2-proxy.github.io/manifests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm upgrade --install --version 4.2.0 --namespace oauth2-proxy-keycloak --create-namespace --values - oauth2-proxy oauth2-proxy/oauth2-proxy &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clientID: oauth2-proxy-keycloak.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clientSecret: "${MY_PASSWORD}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cookieSecret: "$(openssl rand -base64 32 | head -c 32 | base64)"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  configFile: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    email_domains = [ "*" ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    upstreams = [ "file:///dev/null" ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    whitelist_domains = ".${CLUSTER_FQDN}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cookie_domains = ".${CLUSTER_FQDN}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    provider = "keycloak"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    login_url = "https://keycloak.${CLUSTER_FQDN}/auth/realms/myrealm/protocol/openid-connect/auth"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redeem_url = "https://keycloak.${CLUSTER_FQDN}/auth/realms/myrealm/protocol/openid-connect/token"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    profile_url = "https://keycloak.${CLUSTER_FQDN}/auth/realms/myrealm/protocol/openid-connect/userinfo"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    validate_url = "https://keycloak.${CLUSTER_FQDN}/auth/realms/myrealm/protocol/openid-connect/userinfo"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scope = "openid email profile"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_insecure_skip_verify = "true"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    insecure_oidc_skip_issuer_verification = "true"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hosts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - oauth2-proxy-keycloak.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - secretName: ingress-cert-${LETSENCRYPT_ENVIRONMENT}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hosts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - oauth2-proxy-keycloak.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metrics:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  servicemonitor:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="dex">Dex<a class="hash-link" aria-label="Direct link to Dex" title="Direct link to Dex" href="https://blog-test.ruzicka.dev/docosaurus-test/blog/image-test-eks-post#dex">​</a></h2>
<p>Install <code>dex</code>
<a href="https://artifacthub.io/packages/helm/dex/dex" target="_blank" rel="noopener noreferrer">helm chart</a>
and modify the
<a href="https://github.com/dexidp/helm-charts/blob/master/charts/dex/values.yaml" target="_blank" rel="noopener noreferrer">default values</a>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add --force-update dex https://charts.dexidp.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm upgrade --install --version 0.6.0 --namespace dex --create-namespace --values - dex dex/dex &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nginx.ingress.kubernetes.io/ssl-redirect: "false"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hosts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: dex.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - path: /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          pathType: ImplementationSpecific</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - secretName: ingress-cert-${LETSENCRYPT_ENVIRONMENT}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hosts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - dex.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  issuer: https://dex.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      inCluster: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  oauth2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    skipApprovalScreen: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  connectors:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - type: github</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      id: github</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: GitHub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clientID: ${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clientSecret: ${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        redirectURI: https://dex.${CLUSTER_FQDN}/callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orgs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - name: ${MY_GITHUB_ORG_NAME}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - type: oidc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      id: okta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: Okta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        issuer: ${OKTA_ISSUER}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clientID: ${OKTA_CLIENT_ID}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clientSecret: ${OKTA_CLIENT_SECRET}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        redirectURI: https://dex.${CLUSTER_FQDN}/callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scopes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - openid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - profile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - email</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        getUserInfo: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  staticClients:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - id: argocd.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      redirectURIs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - https://argocd.${CLUSTER_FQDN}/auth/callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: ArgoCD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      secret: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - id: gangway.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      redirectURIs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - https://gangway.${CLUSTER_FQDN}/callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: Gangway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      secret: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - id: harbor.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      redirectURIs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - https://harbor.${CLUSTER_FQDN}/c/oidc/callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: Harbor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      secret: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - id: kiali.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      redirectURIs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - https://kiali.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: Kiali</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      secret: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - id: keycloak.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      redirectURIs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - https://keycloak.${CLUSTER_FQDN}/auth/realms/myrealm/broker/dex/endpoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: Keycloak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      secret: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - id: oauth2-proxy.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      redirectURIs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - https://oauth2-proxy.${CLUSTER_FQDN}/oauth2/callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: OAuth2 Proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      secret: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - id: vault.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      redirectURIs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - https://vault.${CLUSTER_FQDN}/ui/vault/auth/oidc/oidc/callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - http://localhost:8250/oidc/callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: Vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      secret: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enablePasswordDB: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="oauth2-proxy">oauth2-proxy<a class="hash-link" aria-label="Direct link to oauth2-proxy" title="Direct link to oauth2-proxy" href="https://blog-test.ruzicka.dev/docosaurus-test/blog/image-test-eks-post#oauth2-proxy">​</a></h2>
<p>Install <a href="https://github.com/oauth2-proxy/oauth2-proxy" target="_blank" rel="noopener noreferrer">oauth2-proxy</a> to secure
the endpoints like (<code>prometheus.</code>, <code>alertmanager.</code>).</p>
<p>Install <code>oauth2-proxy</code>
<a href="https://artifacthub.io/packages/helm/oauth2-proxy/oauth2-proxy" target="_blank" rel="noopener noreferrer">helm chart</a>
and modify the
<a href="https://github.com/oauth2-proxy/manifests/blob/main/helm/oauth2-proxy/values.yaml" target="_blank" rel="noopener noreferrer">default values</a>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm upgrade --install --version 4.2.0 --namespace oauth2-proxy --create-namespace --values - oauth2-proxy oauth2-proxy/oauth2-proxy &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clientID: oauth2-proxy.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clientSecret: "${MY_PASSWORD}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cookieSecret: "$(openssl rand -base64 32 | head -c 32 | base64)"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  configFile: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    email_domains = [ "*" ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    upstreams = [ "file:///dev/null" ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    whitelist_domains = ".${CLUSTER_FQDN}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cookie_domains = ".${CLUSTER_FQDN}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    provider = "oidc"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    oidc_issuer_url = "https://dex.${CLUSTER_FQDN}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_insecure_skip_verify = "true"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    insecure_oidc_skip_issuer_verification = "true"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hosts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - oauth2-proxy.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - secretName: ingress-cert-${LETSENCRYPT_ENVIRONMENT}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hosts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - oauth2-proxy.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metrics:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  servicemonitor:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="gangway">Gangway<a class="hash-link" aria-label="Direct link to Gangway" title="Direct link to Gangway" href="https://blog-test.ruzicka.dev/docosaurus-test/blog/image-test-eks-post#gangway">​</a></h2>
<p>Install gangway:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add --force-update stable https://charts.helm.sh/stable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm upgrade --install --version 0.4.5 --namespace gangway --create-namespace --values - gangway stable/gangway &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/helm/charts/blob/master/stable/gangway/values.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">trustedCACert: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$(curl -s "${LETSENCRYPT_CERTIFICATE}" | sed "s/^/  /")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gangway:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clusterName: ${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  authorizeURL: https://dex.${CLUSTER_FQDN}/auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tokenURL: https://dex.${CLUSTER_FQDN}/token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  audience: https://dex.${CLUSTER_FQDN}/userinfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  redirectURL: https://gangway.${CLUSTER_FQDN}/callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clientID: gangway.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clientSecret: ${MY_PASSWORD}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apiServerURL: https://kube-oidc-proxy.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nginx.ingress.kubernetes.io/auth-url: https://oauth2-proxy.${CLUSTER_FQDN}/oauth2/auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nginx.ingress.kubernetes.io/auth-signin: https://oauth2-proxy.${CLUSTER_FQDN}/oauth2/start?rd=\$scheme://\$host\$request_uri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hosts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - gangway.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - secretName: ingress-cert-${LETSENCRYPT_ENVIRONMENT}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hosts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - gangway.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="kube-oidc-proxy">kube-oidc-proxy<a class="hash-link" aria-label="Direct link to kube-oidc-proxy" title="Direct link to kube-oidc-proxy" href="https://blog-test.ruzicka.dev/docosaurus-test/blog/image-test-eks-post#kube-oidc-proxy">​</a></h2>
<p>The <code>kube-oidc-proxy</code> accepting connections only via HTTPS. It's necessary to
configure ingress to communicate with the backend over HTTPS.</p>
<p>Install kube-oidc-proxy:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test -d "tmp/${CLUSTER_FQDN}/kube-oidc-proxy" || git clone --quiet https://github.com/jetstack/kube-oidc-proxy.git "tmp/${CLUSTER_FQDN}/kube-oidc-proxy"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git -C "tmp/${CLUSTER_FQDN}/kube-oidc-proxy" checkout --quiet v0.3.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm upgrade --install --namespace kube-oidc-proxy --create-namespace --values - kube-oidc-proxy "tmp/${CLUSTER_FQDN}/kube-oidc-proxy/deploy/charts/kube-oidc-proxy" &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/jetstack/kube-oidc-proxy/blob/master/deploy/charts/kube-oidc-proxy/values.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oidc:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clientId: gangway.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  issuerUrl: https://dex.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  usernameClaim: email</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  caPEM: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$(curl -s "${LETSENCRYPT_CERTIFICATE}" | sed "s/^/    /")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nginx.ingress.kubernetes.io/backend-protocol: HTTPS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hosts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - host: kube-oidc-proxy.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - secretName: ingress-cert-${LETSENCRYPT_ENVIRONMENT}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     hosts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - kube-oidc-proxy.${CLUSTER_FQDN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you get the credentials form the <a href="https://gangway.kube1.k8s.mylabs.dev/" target="_blank" rel="noopener noreferrer">https://gangway.kube1.k8s.mylabs.dev</a>
you will have the access to the cluster, but no rights there.</p>
<p>Add access rights to the user:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: kube-prometheus-stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: secret-reader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- apiGroups: [""]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resources: ["secrets"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  verbs: ["get", "watch", "list"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: RoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: read-secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: kube-prometheus-stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subjects:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- kind: User</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: ${MY_EMAIL}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apiGroup: rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">roleRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind: Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: secret-reader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apiGroup: rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: pods-reader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- apiGroups: [""]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resources: ["pods"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  verbs: ["get", "watch", "list"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ClusterRoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: read-pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subjects:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- kind: User</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: ${MY_EMAIL}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apiGroup: rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">roleRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind: ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: pods-reader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apiGroup: rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The user should be able to read the secrets in <code>kube-prometheus-stack</code>
namespace:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe secrets --insecure-skip-tls-verify -n kube-prometheus-stack "ingress-cert-${LETSENCRYPT_ENVIRONMENT}" # DevSkim: ignore DS126188</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Output:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Name:         ingress-cert-staging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:    kube-prometheus-stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:       kubed.appscode.com/origin.cluster=kube1.k8s.mylabs.dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              kubed.appscode.com/origin.name=ingress-cert-staging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              kubed.appscode.com/origin.namespace=cert-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:  cert-manager.io/alt-names: *.kube1.k8s.mylabs.dev,kube1.k8s.mylabs.dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cert-manager.io/certificate-name: ingress-cert-staging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cert-manager.io/common-name: *.kube1.k8s.mylabs.dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cert-manager.io/ip-sans:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cert-manager.io/issuer-group:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cert-manager.io/issuer-kind: ClusterIssuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cert-manager.io/issuer-name: letsencrypt-staging-dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cert-manager.io/uri-sans:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              kubed.appscode.com/origin:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {"namespace":"cert-manager","name":"ingress-cert-staging","uid":"f1ed062c-23d9-4cf7-ad51-cfafd8a3b788","resourceVersion":"5296"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type:  kubernetes.io/tls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">====</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tls.crt:  3586 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tls.key:  1679 bytes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>But it's not allowed to delete the secrets for the user:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete secrets --insecure-skip-tls-verify -n kube-prometheus-stack "ingress-cert-${LETSENCRYPT_ENVIRONMENT}"   # DevSkim: ignore DS126188</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Output:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Error from server (Forbidden): secrets "ingress-cert-staging" is forbidden: User "petr.ruzicka@gmail.com" cannot delete resource "secrets" in API group "" in the namespace "kube-prometheus-stack"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The user can not read secrets outside the <code>kube-prometheus-stack</code>:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get secrets --insecure-skip-tls-verify -n kube-system                                                          # DevSkim: ignore DS126188</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Output:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Error from server (Forbidden): secrets is forbidden: User "petr.ruzicka@gmail.com" cannot list resource "secrets" in API group "" in the namespace "kube-system"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can see the pods "everywhere":</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods --insecure-skip-tls-verify -n kube-system                                                             # DevSkim: ignore DS126188</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Output:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                         READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws-for-fluent-bit-5hxlt                                     1/1     Running   0          32m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws-for-fluent-bit-dmvzq                                     1/1     Running   0          32m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws-node-ggfft                                               1/1     Running   0          32m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws-node-lhlvf                                               1/1     Running   0          32m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster-autoscaler-aws-cluster-autoscaler-7f878bccc8-s279k   1/1     Running   0          25m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">coredns-59b69b4849-6v487                                     1/1     Running   0          46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">coredns-59b69b4849-tw2dg                                     1/1     Running   0          46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ebs-csi-controller-86785d75db-7brbr                          5/5     Running   0          31m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ebs-csi-controller-86785d75db-gn4ll                          5/5     Running   0          31m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ebs-csi-node-6h9zv                                           3/3     Running   0          31m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ebs-csi-node-r5rj7                                           3/3     Running   0          31m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-proxy-m6dm8                                             1/1     Running   0          32m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-proxy-pdmv9                                             1/1     Running   0          32m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>But you can not delete them:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete pods --insecure-skip-tls-verify -n kube-oidc-proxy --all                                                # DevSkim: ignore DS126188</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Output:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Error from server (Forbidden): pods "kube-oidc-proxy-74bf5679fd-jhdmr" is forbidden: User "petr.ruzicka@gmail.com" cannot delete resource "pods" in API group "" in the namespace "kube-oidc-proxy"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>EKS</category>
            <category>Image</category>
            <category>Pipeline Templates</category>
        </item>
        <item>
            <title><![CDATA[Long Blog Post]]></title>
            <link>https://blog-test.ruzicka.dev/docosaurus-test/blog/long-blog-post</link>
            <guid>https://blog-test.ruzicka.dev/docosaurus-test/blog/long-blog-post</guid>
            <pubDate>Wed, 29 May 2019 00:00:00 GMT</pubDate>
            <description><![CDATA[This is the summary of a very long blog post,]]></description>
            <content:encoded><![CDATA[<p>This is the summary of a very long blog post,</p>
<p>Use a <code>&lt;!--</code> <code>truncate</code> <code>--&gt;</code> comment to limit blog post size in the list view.</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>]]></content:encoded>
            <category>hello</category>
            <category>docusaurus</category>
        </item>
        <item>
            <title><![CDATA[First Blog Post]]></title>
            <link>https://blog-test.ruzicka.dev/docosaurus-test/blog/first-blog-post</link>
            <guid>https://blog-test.ruzicka.dev/docosaurus-test/blog/first-blog-post</guid>
            <pubDate>Tue, 28 May 2019 00:00:00 GMT</pubDate>
            <description><![CDATA[Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet]]></description>
            <content:encoded><![CDATA[<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet</p>]]></content:encoded>
            <category>hola</category>
            <category>docusaurus</category>
        </item>
    </channel>
</rss>