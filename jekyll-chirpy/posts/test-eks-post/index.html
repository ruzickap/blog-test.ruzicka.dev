<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Test EKS Post" /><meta property="og:locale" content="en" /><meta name="description" content="Amazon EKS Bottlerocket and Fargate" /><meta property="og:description" content="Amazon EKS Bottlerocket and Fargate" /><link rel="canonical" href="/jekyll-chirpy/posts/test-eks-post/" /><meta property="og:url" content="/jekyll-chirpy/posts/test-eks-post/" /><meta property="og:site_name" content="Petr’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-12-10T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Test EKS Post" /><meta name="twitter:site" content="@Ruzicka_Petr" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-12-10T00:00:00+01:00","datePublished":"2020-12-10T00:00:00+01:00","description":"Amazon EKS Bottlerocket and Fargate","headline":"Test EKS Post","mainEntityOfPage":{"@type":"WebPage","@id":"/jekyll-chirpy/posts/test-eks-post/"},"url":"/jekyll-chirpy/posts/test-eks-post/"}</script><title>Test EKS Post | Petr's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/jekyll-chirpy/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/jekyll-chirpy/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/jekyll-chirpy/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/jekyll-chirpy/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/jekyll-chirpy/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Petr's Blog"><meta name="application-name" content="Petr's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/jekyll-chirpy/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/jekyll-chirpy/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.27.20/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { let self = this;this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { self.clearMode(); } self.notify(); }); if (!this.hasMode) { return; } if (this.isDarkMode) { this.setDark(); } else { this.setLight(); } } get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isPreferDark() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }get modeStatus() { if (this.hasMode) { return this.mode; } else { return this.isPreferDark ? ModeToggle.DARK_MODE : ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); }notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { this.clearMode(); } else { if (this.isPreferDark) { this.setLight(); } else { this.setDark(); } } this.notify(); } } const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/jekyll-chirpy/" id="avatar" class="rounded-circle"><img src="https://0.gravatar.com/avatar/5484c0fd9f98e2ffd9212b158931bf4b?s=200" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/jekyll-chirpy/">Petr's Blog</a></h1><p class="site-subtitle fst-italic mb-0">DevOps • GitOps • K8s</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/jekyll-chirpy/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/jekyll-chirpy/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/jekyll-chirpy/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/jekyll-chirpy/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/jekyll-chirpy/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ruzickap" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="javascript:location.href = 'mailto:' + ['petr.ruzicka','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/petrruzicka/" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="/jekyll-chirpy/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/jekyll-chirpy/">Home</a> </span> <span>Test EKS Post</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>Test EKS Post</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1607554800" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Dec 10, 2020 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://petr.ruzicka.dev">Petr Ruzicka</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="5192 words" > <em>28 min</em> read</span></div></div></div></header><div class="content"><h1 id="amazon-eks-bottlerocket-and-fargate">Amazon EKS Bottlerocket and Fargate</h1><p><a href="https://raw.githubusercontent.com/cncf/landscape/7f5b02ecba914a32912e77fc78e1c54d1c2f98ec/hosted_logos/amazon-eks.svg?sanitize=true" class="popup img-link shimmer"><img src="https://raw.githubusercontent.com/cncf/landscape/7f5b02ecba914a32912e77fc78e1c54d1c2f98ec/hosted_logos/amazon-eks.svg?sanitize=true" alt="Amazon EKS" title="Amazon EKS" loading="lazy"></a></p><p>Before starting with the main content, it’s necessary to provision the <a href="https://aws.amazon.com/eks/">Amazon EKS</a> in AWS.</p><h2 id="requirements"><span class="me-2">Requirements</span><a href="#requirements" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>If you would like to follow this documents and it’s task you will need to set up few environment variables.</p><p>The <code class="language-plaintext highlighter-rouge">LETSENCRYPT_ENVIRONMENT</code> variable should be one of:</p><ul><li><code class="language-plaintext highlighter-rouge">staging</code> - Let’s Encrypt will create testing certificate (not valid)<li><code class="language-plaintext highlighter-rouge">production</code> - Let’s Encrypt will create valid certificate (use with care)</ul><p><code class="language-plaintext highlighter-rouge">BASE_DOMAIN</code> contains DNS records for all your Kubernetes clusters. The cluster names will look like <code class="language-plaintext highlighter-rouge">CLUSTER_NAME</code>.<code class="language-plaintext highlighter-rouge">BASE_DOMAIN</code> (<code class="language-plaintext highlighter-rouge">kube1.k8s.mylabs.dev</code>).</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c"># Hostname / FQDN definitions</span>
<span class="nb">export </span><span class="nv">BASE_DOMAIN</span><span class="o">=</span><span class="k">${</span><span class="nv">BASE_DOMAIN</span><span class="k">:-</span><span class="nv">k8s</span><span class="p">.mylabs.dev</span><span class="k">}</span>
<span class="nb">export </span><span class="nv">CLUSTER_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">:-</span><span class="nv">kube1</span><span class="k">}</span>
<span class="nb">export </span><span class="nv">CLUSTER_FQDN</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span><span class="s2">.</span><span class="k">${</span><span class="nv">BASE_DOMAIN</span><span class="k">}</span><span class="s2">"</span>
<span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span><span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>/kubeconfig-<span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span>.conf
<span class="c"># * "production" - valid certificates signed by Lets Encrypt ""</span>
<span class="c"># * "staging" - not trusted certs signed by Lets Encrypt "Fake LE Intermediate X1"</span>
<span class="nb">export </span><span class="nv">LETSENCRYPT_ENVIRONMENT</span><span class="o">=</span><span class="s2">"staging"</span>
<span class="nb">export </span><span class="nv">LETSENCRYPT_CERTIFICATE</span><span class="o">=</span><span class="s2">"https://letsencrypt.org/certs/staging/letsencrypt-stg-root-x1.pem"</span>
<span class="c"># export LETSENCRYPT_ENVIRONMENT="production"</span>
<span class="c"># export LETSENCRYPT_CERTIFICATE="https://letsencrypt.org/certs/lets-encrypt-r3.pem"</span>
<span class="nb">export </span><span class="nv">MY_EMAIL</span><span class="o">=</span><span class="s2">"petr.ruzicka@gmail.com"</span>
<span class="c"># GitHub Organization + Team where are the users who will have the admin access</span>
<span class="c"># to K8s resources (Grafana). Only users in GitHub organization</span>
<span class="c"># (MY_GITHUB_ORG_NAME) will be able to access the apps via ingress.</span>
<span class="nb">export </span><span class="nv">MY_GITHUB_ORG_NAME</span><span class="o">=</span><span class="s2">"ruzickap-org"</span>
<span class="nb">export </span><span class="nv">MY_GITHUB_USERNAME</span><span class="o">=</span><span class="s2">"ruzickap"</span>
<span class="c"># AWS Region</span>
<span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span><span class="s2">"eu-west-1"</span>
<span class="nb">export </span><span class="nv">SLACK_CHANNEL</span><span class="o">=</span><span class="s2">"mylabs"</span>
<span class="c"># Tags used to tag the AWS resources</span>
<span class="nb">export </span><span class="nv">TAGS</span><span class="o">=</span><span class="s2">"Owner=</span><span class="k">${</span><span class="nv">MY_EMAIL</span><span class="k">}</span><span class="s2"> Environment=Dev Group=Cloud_Native Squad=Cloud_Container_Platform compliance:na:defender=bottlerocket"</span>
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MY_EMAIL</span><span class="k">}</span><span class="s2"> | </span><span class="k">${</span><span class="nv">LETSENCRYPT_ENVIRONMENT</span><span class="k">}</span><span class="s2"> | </span><span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span><span class="s2"> | </span><span class="k">${</span><span class="nv">BASE_DOMAIN</span><span class="k">}</span><span class="s2"> | </span><span class="k">${</span><span class="nv">CLUSTER_FQDN</span><span class="k">}</span><span class="se">\n</span><span class="k">${</span><span class="nv">TAGS</span><span class="k">}</span><span class="s2">"</span>
</pre></table></code></div></div><p>Prepare GitHub OAuth “access” credentials ans AWS “access” variables.</p><p>You will need to configure AWS CLI: <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html">Configuring the AWS CLI</a></p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="c"># Common password</span>
<span class="nb">export </span><span class="nv">MY_PASSWORD</span><span class="o">=</span><span class="s2">"xxxx"</span>
<span class="c"># AWS Credentials</span>
<span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s2">""</span>
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s2">""</span>
<span class="nb">export </span><span class="nv">AWS_CONSOLE_ADMIN_ROLE_ARN</span><span class="o">=</span><span class="s2">"arn:aws:iam::7xxxxxxxxxx7:role/xxxxxxxxxxxxxN"</span>
<span class="c"># GitHub Organization OAuth Apps credentials</span>
<span class="nb">export </span><span class="nv">MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID</span><span class="o">=</span><span class="s2">"3xxxxxxxxxxxxxxxxxx3"</span>
<span class="nb">export </span><span class="nv">MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET</span><span class="o">=</span><span class="s2">"7xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx8"</span>
<span class="nb">export </span><span class="nv">MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID</span><span class="o">=</span><span class="s2">"4xxxxxxxxxxxxxxxxxx4"</span>
<span class="nb">export </span><span class="nv">MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET</span><span class="o">=</span><span class="s2">"7xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxa"</span>
<span class="c"># Sysdig credentials</span>
<span class="nb">export </span><span class="nv">SYSDIG_AGENT_ACCESSKEY</span><span class="o">=</span><span class="s2">"xxx"</span>
<span class="c"># Aqua credentials</span>
<span class="nb">export </span><span class="nv">AQUA_REGISTRY_USERNAME</span><span class="o">=</span><span class="s2">"xxx"</span>
<span class="nb">export </span><span class="nv">AQUA_REGISTRY_PASSWORD</span><span class="o">=</span><span class="s2">"xxx"</span>
<span class="nb">export </span><span class="nv">AQUA_ENFORCER_TOKEN</span><span class="o">=</span><span class="s2">"xxx"</span>
<span class="c"># Splunk credentials</span>
<span class="nb">export </span><span class="nv">SPLUNK_HOST</span><span class="o">=</span><span class="s2">"xxx"</span>
<span class="nb">export </span><span class="nv">SPLUNK_TOKEN</span><span class="o">=</span><span class="s2">"xxx"</span>
<span class="nb">export </span><span class="nv">SPLUNK_INDEX_NAME</span><span class="o">=</span><span class="s2">"xxx"</span>
<span class="c"># Slack incoming webhook</span>
<span class="nb">export </span><span class="nv">SLACK_INCOMING_WEBHOOK_URL</span><span class="o">=</span><span class="s2">"https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"</span>
<span class="nb">export </span><span class="nv">SLACK_BOT_API_TOKEN</span><span class="o">=</span><span class="s2">"xxxx-xxxxxxxxxxxxx-xxxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxP"</span>
<span class="c"># Okta configuration</span>
<span class="nb">export </span><span class="nv">OKTA_ISSUER</span><span class="o">=</span><span class="s2">"https://exxxxxxx-xxxxx-xx.okta.com"</span>
<span class="nb">export </span><span class="nv">OKTA_CLIENT_ID</span><span class="o">=</span><span class="s2">"0xxxxxxxxxxxxxxxxxx7"</span>
<span class="nb">export </span><span class="nv">OKTA_CLIENT_SECRET</span><span class="o">=</span><span class="s2">"1xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxH"</span>
</pre></table></code></div></div><p>Verify if all the necessary variables were set:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="k">case</span> <span class="s2">"</span><span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span><span class="s2">"</span> <span class="k">in
  </span>kube1<span class="p">)</span>
    <span class="nv">MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID</span><span class="o">=</span><span class="k">${</span><span class="nv">MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID</span><span class="k">:-${</span><span class="nv">MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID_KUBE1</span><span class="k">}}</span>
    <span class="nv">MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET</span><span class="o">=</span><span class="k">${</span><span class="nv">MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET</span><span class="k">:-${</span><span class="nv">MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET_KUBE1</span><span class="k">}}</span>
    <span class="nv">MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID</span><span class="o">=</span><span class="k">${</span><span class="nv">MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID</span><span class="k">:-${</span><span class="nv">MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID_KUBE1</span><span class="k">}}</span>
    <span class="nv">MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET</span><span class="o">=</span><span class="k">${</span><span class="nv">MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET</span><span class="k">:-${</span><span class="nv">MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET_KUBE1</span><span class="k">}}</span>
    <span class="p">;;</span>
  kube2<span class="p">)</span>
    <span class="nv">MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID</span><span class="o">=</span><span class="k">${</span><span class="nv">MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID</span><span class="k">:-${</span><span class="nv">MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID_KUBE2</span><span class="k">}}</span>
    <span class="nv">MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET</span><span class="o">=</span><span class="k">${</span><span class="nv">MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET</span><span class="k">:-${</span><span class="nv">MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET_KUBE2</span><span class="k">}}</span>
    <span class="nv">MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID</span><span class="o">=</span><span class="k">${</span><span class="nv">MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID</span><span class="k">:-${</span><span class="nv">MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID_KUBE2</span><span class="k">}}</span>
    <span class="nv">MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET</span><span class="o">=</span><span class="k">${</span><span class="nv">MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET</span><span class="k">:-${</span><span class="nv">MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET_KUBE2</span><span class="k">}}</span>
    <span class="p">;;</span>
  <span class="k">*</span><span class="p">)</span>
    <span class="nb">echo</span> <span class="s2">"Unsupported cluster name: </span><span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span><span class="s2"> !"</span>
    <span class="nb">exit </span>1
    <span class="p">;;</span>
<span class="k">esac</span>

: <span class="s2">"</span><span class="k">${</span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="p">?</span><span class="k">}</span><span class="s2">"</span>
: <span class="s2">"</span><span class="k">${</span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="p">?</span><span class="k">}</span><span class="s2">"</span>
: <span class="s2">"</span><span class="k">${</span><span class="nv">AWS_CONSOLE_ADMIN_ROLE_ARN</span><span class="p">?</span><span class="k">}</span><span class="s2">"</span>
: <span class="s2">"</span><span class="k">${</span><span class="nv">GITHUB_TOKEN</span><span class="p">?</span><span class="k">}</span><span class="s2">"</span>
: <span class="s2">"</span><span class="k">${</span><span class="nv">SLACK_INCOMING_WEBHOOK_URL</span><span class="p">?</span><span class="k">}</span><span class="s2">"</span>
: <span class="s2">"</span><span class="k">${</span><span class="nv">SLACK_BOT_API_TOKEN</span><span class="p">?</span><span class="k">}</span><span class="s2">"</span>
: <span class="s2">"</span><span class="k">${</span><span class="nv">MY_PASSWORD</span><span class="p">?</span><span class="k">}</span><span class="s2">"</span>
: <span class="s2">"</span><span class="k">${</span><span class="nv">OKTA_ISSUER</span><span class="p">?</span><span class="k">}</span><span class="s2">"</span>
: <span class="s2">"</span><span class="k">${</span><span class="nv">OKTA_CLIENT_ID</span><span class="p">?</span><span class="k">}</span><span class="s2">"</span>
: <span class="s2">"</span><span class="k">${</span><span class="nv">OKTA_CLIENT_SECRET</span><span class="p">?</span><span class="k">}</span><span class="s2">"</span>
</pre></table></code></div></div><h2 id="prepare-the-local-working-environment"><span class="me-2">Prepare the local working environment</span><a href="#prepare-the-local-working-environment" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>::: tip You can skip these steps if you have all the required software already installed. :::</p><p>Install necessary software:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>
<span class="k">if </span><span class="nb">command</span> <span class="nt">-v</span> apt-get &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then
  </span>apt update <span class="nt">-qq</span>
  <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">-qq</span> apache2-utils ansible dnsutils git gnupg2 jq <span class="nb">sudo </span>unzip <span class="o">&gt;</span> /dev/null
<span class="k">fi</span>
</pre></table></code></div></div><p>Install <a href="https://aws.amazon.com/cli/">AWS CLI</a> binary:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">!</span> <span class="nb">command</span> <span class="nt">-v</span> aws &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then
  </span>curl <span class="nt">-sL</span> <span class="s2">"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"</span> <span class="nt">-o</span> <span class="s2">"/tmp/awscliv2.zip"</span>
  unzip <span class="nt">-q</span> <span class="nt">-o</span> /tmp/awscliv2.zip <span class="nt">-d</span> /tmp/
  <span class="nb">sudo</span> /tmp/aws/install
<span class="k">fi</span>
</pre></table></code></div></div><p>Install <a href="https://github.com/kubernetes/kubectl">kubectl</a> binary:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">!</span> <span class="nb">command</span> <span class="nt">-v</span> kubectl &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then</span>
  <span class="c"># https://github.com/kubernetes/kubectl/releases</span>
  <span class="nb">sudo </span>curl <span class="nt">-s</span> <span class="nt">-Lo</span> /usr/local/bin/kubectl <span class="s2">"https://storage.googleapis.com/kubernetes-release/release/v1.21.1/bin/</span><span class="si">$(</span><span class="nb">uname</span> | <span class="nb">sed</span> <span class="s2">"s/./</span><span class="se">\L</span><span class="s2">&amp;/g"</span><span class="si">)</span><span class="s2">/amd64/kubectl"</span>
  <span class="nb">sudo chmod </span>a+x /usr/local/bin/kubectl
<span class="k">fi</span>
</pre></table></code></div></div><p>Install <a href="https://helm.sh/">Helm</a>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">!</span> <span class="nb">command</span> <span class="nt">-v</span> helm &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then</span>
  <span class="c"># https://github.com/helm/helm/releases</span>
  curl <span class="nt">-s</span> https://raw.githubusercontent.com/helm/helm/master/scripts/get | bash <span class="nt">-s</span> <span class="nt">--</span> <span class="nt">--version</span> v3.6.0
<span class="k">fi</span>
</pre></table></code></div></div><p>Install <a href="https://eksctl.io/">eksctl</a>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">!</span> <span class="nb">command</span> <span class="nt">-v</span> eksctl &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then</span>
  <span class="c"># https://github.com/weaveworks/eksctl/releases</span>
  curl <span class="nt">-s</span> <span class="nt">-L</span> <span class="s2">"https://github.com/weaveworks/eksctl/releases/download/0.60.0/eksctl_</span><span class="si">$(</span><span class="nb">uname</span><span class="si">)</span><span class="s2">_amd64.tar.gz"</span> | <span class="nb">sudo tar </span>xz <span class="nt">-C</span> /usr/local/bin/
<span class="k">fi</span>
</pre></table></code></div></div><p>Install <a href="https://github.com/kubernetes-sigs/aws-iam-authenticator">AWS IAM Authenticator for Kubernetes</a>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">!</span> <span class="nb">command</span> <span class="nt">-v</span> aws-iam-authenticator &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then</span>
  <span class="c"># https://docs.aws.amazon.com/eks/latest/userguide/install-aws-iam-authenticator.html</span>
  <span class="nb">sudo </span>curl <span class="nt">-s</span> <span class="nt">-Lo</span> /usr/local/bin/aws-iam-authenticator <span class="s2">"https://amazon-eks.s3.us-west-2.amazonaws.com/1.19.6/2021-01-05/bin/</span><span class="si">$(</span><span class="nb">uname</span> | <span class="nb">sed</span> <span class="s2">"s/./</span><span class="se">\L</span><span class="s2">&amp;/g"</span><span class="si">)</span><span class="s2">/amd64/aws-iam-authenticator"</span>
  <span class="nb">sudo chmod </span>a+x /usr/local/bin/aws-iam-authenticator
<span class="k">fi</span>
</pre></table></code></div></div><p>Install <a href="https://www.vaultproject.io/downloads">vault</a>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">!</span> <span class="nb">command</span> <span class="nt">-v</span> vault &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then
  </span>curl <span class="nt">-s</span> <span class="nt">-L</span> <span class="s2">"https://releases.hashicorp.com/vault/1.7.2/vault_1.7.2_</span><span class="si">$(</span><span class="nb">uname</span> | <span class="nb">sed</span> <span class="s2">"s/./</span><span class="se">\L</span><span class="s2">&amp;/g"</span><span class="si">)</span><span class="s2">_amd64.zip"</span> <span class="nt">-o</span> /tmp/vault.zip
  <span class="nb">sudo </span>unzip <span class="nt">-q</span> /tmp/vault.zip <span class="nt">-d</span> /usr/local/bin/
  <span class="nb">rm</span> /tmp/vault.zip
<span class="k">fi</span>
</pre></table></code></div></div><p>Install <a href="https://github.com/vmware-tanzu/velero/releases">velero</a>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">!</span> <span class="nb">command</span> <span class="nt">-v</span> velero &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then
  </span>curl <span class="nt">-s</span> <span class="nt">-L</span> <span class="s2">"https://github.com/vmware-tanzu/velero/releases/download/v1.6.0/velero-v1.6.0-</span><span class="si">$(</span><span class="nb">uname</span> | <span class="nb">sed</span> <span class="s2">"s/./</span><span class="se">\L</span><span class="s2">&amp;/g"</span><span class="si">)</span><span class="s2">-amd64.tar.gz"</span> <span class="nt">-o</span> /tmp/velero.tar.gz
  <span class="nb">sudo tar </span>xzf /tmp/velero.tar.gz <span class="nt">-C</span> /usr/local/bin/ <span class="nt">--strip-components</span> 1 <span class="s2">"velero-v1.6.0-</span><span class="si">$(</span><span class="nb">uname</span> | <span class="nb">sed</span> <span class="s2">"s/./</span><span class="se">\L</span><span class="s2">&amp;/g"</span><span class="si">)</span><span class="s2">-amd64/velero"</span>
<span class="k">fi</span>
</pre></table></code></div></div><p>Install <a href="https://toolkit.fluxcd.io/">flux</a>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">!</span> <span class="nb">command</span> <span class="nt">-v</span> flux &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then
  </span>curl <span class="nt">-s</span> https://fluxcd.io/install.sh | <span class="nb">sudo </span>bash
<span class="k">fi</span>
</pre></table></code></div></div><p>Install <code class="language-plaintext highlighter-rouge">calicoctl</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">!</span> <span class="nb">command</span> <span class="nt">-v</span> calicoctl &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then
  </span><span class="nb">sudo </span>curl <span class="nt">-s</span> <span class="nt">-Lo</span> /usr/local/bin/calicoctl https://github.com/projectcalico/calicoctl/releases/download/v3.20.0/calicoctl
  <span class="nb">sudo chmod </span>a+x /usr/local/bin/calicoctl
<span class="k">fi</span>
</pre></table></code></div></div><p>Install <a href="https://github.com/mozilla/sops">SOPS: Secrets OPerationS</a>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">!</span> <span class="nb">command</span> <span class="nt">-v</span> sops &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then
  </span><span class="nb">sudo </span>curl <span class="nt">-s</span> <span class="nt">-Lo</span> /usr/local/bin/sops <span class="s2">"https://github.com/mozilla/sops/releases/download/v3.7.1/sops-v3.7.1.</span><span class="si">$(</span><span class="nb">uname</span> | <span class="nb">sed</span> <span class="s2">"s/./</span><span class="se">\L</span><span class="s2">&amp;/g"</span><span class="si">)</span><span class="s2">"</span>
  <span class="nb">sudo chmod </span>a+x /usr/local/bin/sops
<span class="k">fi</span>
</pre></table></code></div></div><p>Install <a href="https://kustomize.io/">kustomize</a>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">!</span> <span class="nb">command</span> <span class="nt">-v</span> kustomize &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then
  </span>curl <span class="nt">-s</span> <span class="s2">"https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh"</span> | <span class="nb">sudo </span>bash <span class="nt">-s</span> 4.1.2 /usr/local/bin/
<span class="k">fi</span>
</pre></table></code></div></div><p>Install <a href="https://github.com/rakyll/hey">hey</a>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">!</span> <span class="nb">command</span> <span class="nt">-v</span> hey &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then
  </span><span class="nb">sudo </span>curl <span class="nt">-s</span> <span class="nt">-Lo</span> /usr/local/bin/hey <span class="s2">"https://hey-release.s3.us-east-2.amazonaws.com/hey_</span><span class="si">$(</span><span class="nb">uname</span> | <span class="nb">sed</span> <span class="s2">"s/./</span><span class="se">\L</span><span class="s2">&amp;/g"</span><span class="si">)</span><span class="s2">_amd64"</span>
  <span class="nb">sudo chmod </span>a+x /usr/local/bin/hey
<span class="k">fi</span>
</pre></table></code></div></div><h2 id="configure-aws-route-53-domain-delegation"><span class="me-2">Configure AWS Route 53 Domain delegation</span><a href="#configure-aws-route-53-domain-delegation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Create DNS zone (<code class="language-plaintext highlighter-rouge">BASE_DOMAIN</code>):</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>aws route53 create-hosted-zone <span class="nt">--output</span> json <span class="se">\</span>
  <span class="nt">--name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">BASE_DOMAIN</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">--caller-reference</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">date</span><span class="si">)</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">--hosted-zone-config</span><span class="o">=</span><span class="s2">"{</span><span class="se">\"</span><span class="s2">Comment</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">Created by </span><span class="k">${</span><span class="nv">MY_EMAIL</span><span class="k">}</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">PrivateZone</span><span class="se">\"</span><span class="s2">: false}"</span> | jq
</pre></table></code></div></div><p>Use your domain registrar to change the nameservers for your zone (for example “mylabs.dev”) to use the Amazon Route 53 nameservers. Here is the way how you can find out the the Route 53 nameservers:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">NEW_ZONE_ID</span><span class="o">=</span><span class="si">$(</span>aws route53 list-hosted-zones <span class="nt">--query</span> <span class="s2">"HostedZones[?Name==</span><span class="se">\`</span><span class="k">${</span><span class="nv">BASE_DOMAIN</span><span class="k">}</span><span class="s2">.</span><span class="se">\`</span><span class="s2">].Id"</span> <span class="nt">--output</span> text<span class="si">)</span>
<span class="nv">NEW_ZONE_NS</span><span class="o">=</span><span class="si">$(</span>aws route53 get-hosted-zone <span class="nt">--output</span> json <span class="nt">--id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NEW_ZONE_ID</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"DelegationSet.NameServers"</span><span class="si">)</span>
<span class="nv">NEW_ZONE_NS1</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NEW_ZONE_NS</span><span class="k">}</span><span class="s2">"</span> | jq <span class="nt">-r</span> <span class="s2">".[0]"</span><span class="si">)</span>
<span class="nv">NEW_ZONE_NS2</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NEW_ZONE_NS</span><span class="k">}</span><span class="s2">"</span> | jq <span class="nt">-r</span> <span class="s2">".[1]"</span><span class="si">)</span>
</pre></table></code></div></div><p>Create the NS record in <code class="language-plaintext highlighter-rouge">k8s.mylabs.dev</code> (<code class="language-plaintext highlighter-rouge">BASE_DOMAIN</code>) for proper zone delegation. This step depends on your domain registrar - I’m using CloudFlare and using Ansible to automate it:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ansible <span class="nt">-m</span> cloudflare_dns <span class="nt">-c</span> <span class="nb">local</span> <span class="nt">-i</span> <span class="s2">"localhost,"</span> localhost <span class="nt">-a</span> <span class="s2">"zone=mylabs.dev record=</span><span class="k">${</span><span class="nv">BASE_DOMAIN</span><span class="k">}</span><span class="s2"> type=NS value=</span><span class="k">${</span><span class="nv">NEW_ZONE_NS1</span><span class="k">}</span><span class="s2"> solo=true proxied=no account_email=</span><span class="k">${</span><span class="nv">CLOUDFLARE_EMAIL</span><span class="k">}</span><span class="s2"> account_api_token=</span><span class="k">${</span><span class="nv">CLOUDFLARE_API_KEY</span><span class="k">}</span><span class="s2">"</span>
ansible <span class="nt">-m</span> cloudflare_dns <span class="nt">-c</span> <span class="nb">local</span> <span class="nt">-i</span> <span class="s2">"localhost,"</span> localhost <span class="nt">-a</span> <span class="s2">"zone=mylabs.dev record=</span><span class="k">${</span><span class="nv">BASE_DOMAIN</span><span class="k">}</span><span class="s2"> type=NS value=</span><span class="k">${</span><span class="nv">NEW_ZONE_NS2</span><span class="k">}</span><span class="s2"> solo=false proxied=no account_email=</span><span class="k">${</span><span class="nv">CLOUDFLARE_EMAIL</span><span class="k">}</span><span class="s2"> account_api_token=</span><span class="k">${</span><span class="nv">CLOUDFLARE_API_KEY</span><span class="k">}</span><span class="s2">"</span>
</pre></table></code></div></div><p>Output:</p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre><td class="rouge-code"><pre>localhost | CHANGED =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    },
    "changed": true,
    "result": {
        "record": {
            "content": "ns-885.awsdns-46.net",
            "created_on": "2020-11-13T06:25:32.18642Z",
            "id": "dxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxb",
            "locked": false,
            "meta": {
                "auto_added": false,
                "managed_by_apps": false,
                "managed_by_argo_tunnel": false,
                "source": "primary"
            },
            "modified_on": "2020-11-13T06:25:32.18642Z",
            "name": "k8s.mylabs.dev",
            "proxiable": false,
            "proxied": false,
            "ttl": 1,
            "type": "NS",
            "zone_id": "2xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxe",
            "zone_name": "mylabs.dev"
        }
    }
}
localhost | CHANGED =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    },
    "changed": true,
    "result": {
        "record": {
            "content": "ns-1692.awsdns-19.co.uk",
            "created_on": "2020-11-13T06:25:37.605605Z",
            "id": "9xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxb",
            "locked": false,
            "meta": {
                "auto_added": false,
                "managed_by_apps": false,
                "managed_by_argo_tunnel": false,
                "source": "primary"
            },
            "modified_on": "2020-11-13T06:25:37.605605Z",
            "name": "k8s.mylabs.dev",
            "proxiable": false,
            "proxied": false,
            "ttl": 1,
            "type": "NS",
            "zone_id": "2xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxe",
            "zone_name": "mylabs.dev"
        }
    }
}
</pre></table></code></div></div><h2 id="add-new-domain-to-route-53-policies-s3-ebs"><span class="me-2">Add new domain to Route 53, Policies, S3, EBS</span><a href="#add-new-domain-to-route-53-policies-s3-ebs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Details with examples are described on these links:</p><ul><li><a href="https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/">https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/</a><li><a href="https://cert-manager.io/docs/configuration/acme/dns01/route53/">https://cert-manager.io/docs/configuration/acme/dns01/route53/</a><li><a href="https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/aws.md">https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/aws.md</a></ul><p>Create CloudFormation template containing policies for Route53, S3 access (Harbor, Velero) and Domain. Put new domain <code class="language-plaintext highlighter-rouge">CLUSTER_FQDN</code> to the Route 53 and configure the DNS delegation from the <code class="language-plaintext highlighter-rouge">BASE_DOMAIN</code>.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
</pre><td class="rouge-code"><pre><span class="nb">mkdir</span> <span class="nt">-vp</span> <span class="s2">"tmp/</span><span class="k">${</span><span class="nv">CLUSTER_FQDN</span><span class="k">}</span><span class="s2">"</span>

<span class="nb">cat</span> <span class="o">&gt;</span> <span class="s2">"tmp/</span><span class="k">${</span><span class="nv">CLUSTER_FQDN</span><span class="k">}</span><span class="s2">/aws-route53-iam-s3-kms-asm.yml"</span> <span class="o">&lt;&lt;</span> <span class="sh">\</span><span class="no">EOF</span><span class="sh">
Description: "Template to generate the necessary IAM Policies for access to Route53 and S3"
Parameters:
  ClusterFQDN:
    Description: "Cluster domain where all necessary app subdomains will live (subdomain of BaseDomain). Ex: kube1.k8s.mylabs.dev"
    Type: String
  ClusterName:
    Description: "Cluster Name Ex: kube1"
    Type: String
  BaseDomain:
    Description: "Base domain where cluster domains + their subdomains will live. Ex: k8s.mylabs.dev"
    Type: String
Resources:
  # This AWS control checks whether the status of the AWS Systems Manager association compliance is COMPLIANT or NON_COMPLIANT after the association is executed on an instance.
  ConfigRule:
    Type: "AWS::Config::ConfigRule"
    Properties:
      ConfigRuleName: !Sub "</span><span class="k">${</span><span class="nv">ClusterName</span><span class="k">}</span><span class="sh">-ec2-managedinstance-association-compliance-status-check"
      Scope:
        ComplianceResourceTypes:
          - "AWS::SSM::AssociationCompliance"
      Description: "A Config rule that checks whether the compliance status of the Amazon EC2 Systems Manager association compliance is COMPLIANT or NON_COMPLIANT after the association execution on the instance. The rule is compliant if the field status is COMPLIANT."
      Source:
        Owner: "AWS"
        SourceIdentifier: "EC2_MANAGEDINSTANCE_ASSOCIATION_COMPLIANCE_STATUS_CHECK"
  CloudWatchPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub "</span><span class="k">${</span><span class="nv">ClusterFQDN</span><span class="k">}</span><span class="sh">-CloudWatch"
      Description: !Sub "Policy required by Fargate to log to CloudWatch for </span><span class="k">${</span><span class="nv">ClusterFQDN</span><span class="k">}</span><span class="sh">"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: Allow
          Action:
          - logs:CreateLogStream
          - logs:CreateLogGroup
          - logs:DescribeLogStreams
          - logs:PutLogEvents
          Resource: "*"
  HostedZone:
    Type: AWS::Route53::HostedZone
    Properties:
      Name: !Ref ClusterFQDN
  KMSAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/eks-</span><span class="k">${</span><span class="nv">ClusterName</span><span class="k">}</span><span class="sh">"
      TargetKeyId: !Ref KMSKey
  KMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub "KMS key for secrets related to </span><span class="k">${</span><span class="nv">ClusterFQDN</span><span class="k">}</span><span class="sh">"
      EnableKeyRotation: true
      PendingWindowInDays: 7
      KeyPolicy:
        Version: "2012-10-17"
        Id: !Sub "eks-key-policy-</span><span class="k">${</span><span class="nv">ClusterName</span><span class="k">}</span><span class="sh">"
        Statement:
        - Sid: Enable IAM User Permissions
          Effect: Allow
          Principal:
            AWS: !Sub "arn:aws:iam::</span><span class="k">${</span><span class="nv">AWS</span>::AccountId<span class="k">}</span><span class="sh">:root"
          Action: kms:*
          Resource: "*"
        - Sid: Allow use of the key
          Effect: Allow
          Principal:
            AWS: !Sub "arn:aws:iam::</span><span class="k">${</span><span class="nv">AWS</span>::AccountId<span class="k">}</span><span class="sh">:role/aws-service-role/autoscaling.amazonaws.com/AWSServiceRoleForAutoScaling"
          Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          - kms:DescribeKey
          Resource: "*"
        - Sid: Allow attachment of persistent resources
          Effect: Allow
          Principal:
            AWS: !Sub "arn:aws:iam::</span><span class="k">${</span><span class="nv">AWS</span>::AccountId<span class="k">}</span><span class="sh">:role/aws-service-role/autoscaling.amazonaws.com/AWSServiceRoleForAutoScaling"
          Action:
          - kms:CreateGrant
          Resource: "*"
          Condition:
            Bool:
              kms:GrantIsForAWSResource: true
  EKSViewNodesAndWorkloadsPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub "</span><span class="k">${</span><span class="nv">ClusterFQDN</span><span class="k">}</span><span class="sh">-EKSViewNodesAndWorkloads"
      Description: !Sub "Policy used to view workloads running in an EKS cluster created using CAPA"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: Allow
          Action:
          - eks:DescribeNodegroup
          - eks:ListNodegroups
          - eks:DescribeCluster
          - eks:ListClusters
          - eks:AccessKubernetesApi
          - ssm:GetParameter
          - eks:ListUpdates
          - eks:ListFargateProfiles
          Resource: "*"
  RecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneName: !Sub "</span><span class="k">${</span><span class="nv">BaseDomain</span><span class="k">}</span><span class="sh">."
      Name: !Ref ClusterFQDN
      Type: NS
      TTL: 60
      ResourceRecords: !GetAtt HostedZone.NameServers
  S3Policy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub "</span><span class="k">${</span><span class="nv">ClusterFQDN</span><span class="k">}</span><span class="sh">-AmazonS3"
      Description: !Sub "Policy required by Harbor and Velero to write to S3 bucket </span><span class="k">${</span><span class="nv">ClusterFQDN</span><span class="k">}</span><span class="sh">"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: Allow
          Action:
          - s3:ListBucket
          - s3:GetBucketLocation
          - s3:ListBucketMultipartUploads
          Resource: !GetAtt S3Bucket.Arn
        - Effect: Allow
          Action:
          - s3:PutObject
          - s3:GetObject
          - s3:DeleteObject
          - s3:ListMultipartUploadParts
          - s3:AbortMultipartUpload
          Resource: !Sub "arn:aws:s3:::</span><span class="k">${</span><span class="nv">ClusterFQDN</span><span class="k">}</span><span class="sh">/*"
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      BucketName: !Sub "</span><span class="k">${</span><span class="nv">ClusterFQDN</span><span class="k">}</span><span class="sh">"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
  SecretsManagerMySecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "</span><span class="k">${</span><span class="nv">ClusterFQDN</span><span class="k">}</span><span class="sh">-MySecret"
      Description: My Secret
      GenerateSecretString:
        SecretStringTemplate: "{</span><span class="se">\"</span><span class="sh">username</span><span class="se">\"</span><span class="sh">: </span><span class="se">\"</span><span class="sh">Administrator</span><span class="se">\"</span><span class="sh">}"
        GenerateStringKey: password
        PasswordLength: 32
      KmsKeyId: !Ref KMSKey
  SecretsManagerMySecret2:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "</span><span class="k">${</span><span class="nv">ClusterFQDN</span><span class="k">}</span><span class="sh">-MySecret2"
      Description: My Secret2
      GenerateSecretString:
        SecretStringTemplate: "{</span><span class="se">\"</span><span class="sh">username</span><span class="se">\"</span><span class="sh">: </span><span class="se">\"</span><span class="sh">Administrator2</span><span class="se">\"</span><span class="sh">}"
        GenerateStringKey: password
        PasswordLength: 32
      KmsKeyId: !Ref KMSKey
  UserMyUser1:
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub "myuser1-</span><span class="k">${</span><span class="nv">ClusterName</span><span class="k">}</span><span class="sh">"
      Policies:
      - PolicyName: !Sub "myuser1-</span><span class="k">${</span><span class="nv">ClusterName</span><span class="k">}</span><span class="sh">-policy"
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
          - Sid: AllowAssumeOrganizationAccountRole
            Effect: Allow
            Action: sts:AssumeRole
            Resource: !GetAtt RoleMyUser1.Arn
  AccessKeyMyUser1:
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref UserMyUser1
  RoleMyUser1:
    Type: AWS::IAM::Role
    Properties:
      Description: !Sub "IAM role for the myuser1-</span><span class="k">${</span><span class="nv">ClusterName</span><span class="k">}</span><span class="sh"> user"
      RoleName: !Sub "myuser1-</span><span class="k">${</span><span class="nv">ClusterName</span><span class="k">}</span><span class="sh">"
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            AWS: !Sub "arn:aws:iam::</span><span class="k">${</span><span class="nv">AWS</span>::AccountId<span class="k">}</span><span class="sh">:root"
          Action: sts:AssumeRole
  UserMyUser2:
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub "myuser2-</span><span class="k">${</span><span class="nv">ClusterName</span><span class="k">}</span><span class="sh">"
      Policies:
      - PolicyName: !Sub "myuser2-</span><span class="k">${</span><span class="nv">ClusterName</span><span class="k">}</span><span class="sh">-policy"
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
          - Sid: AllowAssumeOrganizationAccountRole
            Effect: Allow
            Action: sts:AssumeRole
            Resource: !GetAtt RoleMyUser2.Arn
  AccessKeyMyUser2:
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref UserMyUser2
  RoleMyUser2:
    Type: AWS::IAM::Role
    Properties:
      Description: !Sub "IAM role for the myuser2-</span><span class="k">${</span><span class="nv">ClusterName</span><span class="k">}</span><span class="sh"> user"
      RoleName: !Sub "myuser2-</span><span class="k">${</span><span class="nv">ClusterName</span><span class="k">}</span><span class="sh">"
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            AWS: !Sub "arn:aws:iam::</span><span class="k">${</span><span class="nv">AWS</span>::AccountId<span class="k">}</span><span class="sh">:root"
          Action: sts:AssumeRole
Outputs:
  CloudWatchPolicyArn:
    Description: The ARN of the created CloudWatchPolicy
    Value: !Ref CloudWatchPolicy
    Export:
      Name:
        Fn::Sub: "</span><span class="k">${</span><span class="nv">AWS</span>::StackName<span class="k">}</span><span class="sh">-CloudWatchPolicyArn"
  KMSKeyArn:
    Description: The ARN of the created KMS Key to encrypt EKS related services
    Value: !GetAtt KMSKey.Arn
    Export:
      Name:
        Fn::Sub: "</span><span class="k">${</span><span class="nv">AWS</span>::StackName<span class="k">}</span><span class="sh">-KMSKeyArn"
  KMSKeyId:
    Description: The ID of the created KMS Key to encrypt EKS related services
    Value: !Ref KMSKey
    Export:
      Name:
        Fn::Sub: "</span><span class="k">${</span><span class="nv">AWS</span>::StackName<span class="k">}</span><span class="sh">-KMSKeyId"
  HostedZoneArn:
    Description: The ARN of the created Route53 Zone for K8s cluster
    Value: !Ref HostedZone
    Export:
      Name:
        Fn::Sub: "</span><span class="k">${</span><span class="nv">AWS</span>::StackName<span class="k">}</span><span class="sh">-HostedZoneArn"
  S3PolicyArn:
    Description: The ARN of the created AmazonS3 policy
    Value: !Ref S3Policy
    Export:
      Name:
        Fn::Sub: "</span><span class="k">${</span><span class="nv">AWS</span>::StackName<span class="k">}</span><span class="sh">-S3PolicyArn"
  RoleMyUser1Arn:
    Description: The ARN of the MyUser1 IAM Role
    Value: !GetAtt RoleMyUser1.Arn
    Export:
      Name:
        Fn::Sub: "</span><span class="k">${</span><span class="nv">AWS</span>::StackName<span class="k">}</span><span class="sh">-RoleMyUser1Arn"
  AccessKeyMyUser1:
    Description: The AccessKey for MyUser1 user
    Value: !Ref AccessKeyMyUser1
    Export:
      Name:
        Fn::Sub: "</span><span class="k">${</span><span class="nv">AWS</span>::StackName<span class="k">}</span><span class="sh">-AccessKeyMyUser1"
  SecretAccessKeyMyUser1:
    Description: The SecretAccessKey for MyUser1 user
    Value: !GetAtt AccessKeyMyUser1.SecretAccessKey
    Export:
      Name:
        Fn::Sub: "</span><span class="k">${</span><span class="nv">AWS</span>::StackName<span class="k">}</span><span class="sh">-SecretAccessKeyMyUser1"
  RoleMyUser2Arn:
    Description: The ARN of the MyUser2 IAM Role
    Value: !GetAtt RoleMyUser2.Arn
    Export:
      Name:
        Fn::Sub: "</span><span class="k">${</span><span class="nv">AWS</span>::StackName<span class="k">}</span><span class="sh">-RoleMyUser2Arn"
  AccessKeyMyUser2:
    Description: The AccessKey for MyUser2 user
    Value: !Ref AccessKeyMyUser2
    Export:
      Name:
        Fn::Sub: "</span><span class="k">${</span><span class="nv">AWS</span>::StackName<span class="k">}</span><span class="sh">-AccessKeyMyUser2"
  SecretAccessKeyMyUser2:
    Description: The SecretAccessKey for MyUser2 user
    Value: !GetAtt AccessKeyMyUser2.SecretAccessKey
    Export:
      Name:
        Fn::Sub: "</span><span class="k">${</span><span class="nv">AWS</span>::StackName<span class="k">}</span><span class="sh">-SecretAccessKeyMyUser2"
</span><span class="no">EOF

</span><span class="nb">eval </span>aws cloudformation deploy <span class="nt">--capabilities</span> CAPABILITY_NAMED_IAM <span class="se">\</span>
  <span class="nt">--parameter-overrides</span> <span class="s2">"ClusterFQDN=</span><span class="k">${</span><span class="nv">CLUSTER_FQDN</span><span class="k">}</span><span class="s2"> ClusterName=</span><span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span><span class="s2"> BaseDomain=</span><span class="k">${</span><span class="nv">BASE_DOMAIN</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">--stack-name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span><span class="s2">-route53-iam-s3-kms-asm"</span> <span class="nt">--template-file</span> <span class="s2">"tmp/</span><span class="k">${</span><span class="nv">CLUSTER_FQDN</span><span class="k">}</span><span class="s2">/aws-route53-iam-s3-kms-asm.yml"</span> <span class="nt">--tags</span> <span class="s2">"</span><span class="k">${</span><span class="nv">TAGS</span><span class="k">}</span><span class="s2">"</span>

<span class="nv">AWS_CLOUDFORMATION_DETAILS</span><span class="o">=</span><span class="si">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span><span class="s2">-route53-iam-s3-kms-asm"</span><span class="si">)</span>
<span class="c"># CLOUDWATCH_POLICY_ARN=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"CloudWatchPolicyArn\") .OutputValue")</span>
<span class="nv">KMS_KEY_ARN</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">AWS_CLOUDFORMATION_DETAILS</span><span class="k">}</span><span class="s2">"</span> | jq <span class="nt">-r</span> <span class="s2">".Stacks[0].Outputs[] | select(.OutputKey==</span><span class="se">\"</span><span class="s2">KMSKeyArn</span><span class="se">\"</span><span class="s2">) .OutputValue"</span><span class="si">)</span>
<span class="nv">KMS_KEY_ID</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">AWS_CLOUDFORMATION_DETAILS</span><span class="k">}</span><span class="s2">"</span> | jq <span class="nt">-r</span> <span class="s2">".Stacks[0].Outputs[] | select(.OutputKey==</span><span class="se">\"</span><span class="s2">KMSKeyId</span><span class="se">\"</span><span class="s2">) .OutputValue"</span><span class="si">)</span>
<span class="nv">S3_POLICY_ARN</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">AWS_CLOUDFORMATION_DETAILS</span><span class="k">}</span><span class="s2">"</span> | jq <span class="nt">-r</span> <span class="s2">".Stacks[0].Outputs[] | select(.OutputKey==</span><span class="se">\"</span><span class="s2">S3PolicyArn</span><span class="se">\"</span><span class="s2">) .OutputValue"</span><span class="si">)</span>
<span class="c"># MYUSER1_ROLE_ARN=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"RoleMyUser1Arn\") .OutputValue")</span>
<span class="c"># MYUSER1_USER_ACCESSKEYMYUSER=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"AccessKeyMyUser1\") .OutputValue")</span>
<span class="c"># MYUSER1_USER_SECRETACCESSKEY=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"SecretAccessKeyMyUser1\") .OutputValue")</span>
<span class="c"># MYUSER2_ROLE_ARN=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"RoleMyUser2Arn\") .OutputValue")</span>
<span class="c"># MYUSER2_USER_ACCESSKEYMYUSER=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"AccessKeyMyUser2\") .OutputValue")</span>
<span class="c"># MYUSER2_USER_SECRETACCESSKEY=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"SecretAccessKeyMyUser2\") .OutputValue")</span>
</pre></table></code></div></div><p>Change TTL=60 of SOA + NS records for new domain (it can not be done in CloudFormation):</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="nv">HOSTED_ZONE_ID</span><span class="o">=</span><span class="si">$(</span>aws route53 list-hosted-zones <span class="nt">--query</span> <span class="s2">"HostedZones[?Name==</span><span class="se">\`</span><span class="k">${</span><span class="nv">CLUSTER_FQDN</span><span class="k">}</span><span class="s2">.</span><span class="se">\`</span><span class="s2">].Id"</span> <span class="nt">--output</span> text<span class="si">)</span>
<span class="nv">RESOURCE_RECORD_SET_SOA</span><span class="o">=</span><span class="si">$(</span>aws route53 <span class="nt">--output</span> json list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">HOSTED_ZONE_ID</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"(ResourceRecordSets[?Type == </span><span class="se">\`</span><span class="s2">SOA</span><span class="se">\`</span><span class="s2">])[0]"</span> | <span class="nb">sed</span> <span class="s2">"s/</span><span class="se">\"</span><span class="s2">TTL</span><span class="se">\"</span><span class="s2">:.*/</span><span class="se">\"</span><span class="s2">TTL</span><span class="se">\"</span><span class="s2">: 60,/"</span><span class="si">)</span>
<span class="nv">RESOURCE_RECORD_SET_NS</span><span class="o">=</span><span class="si">$(</span>aws route53 <span class="nt">--output</span> json list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">HOSTED_ZONE_ID</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"(ResourceRecordSets[?Type == </span><span class="se">\`</span><span class="s2">NS</span><span class="se">\`</span><span class="s2">])[0]"</span> | <span class="nb">sed</span> <span class="s2">"s/</span><span class="se">\"</span><span class="s2">TTL</span><span class="se">\"</span><span class="s2">:.*/</span><span class="se">\"</span><span class="s2">TTL</span><span class="se">\"</span><span class="s2">: 60,/"</span><span class="si">)</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | aws route53 --output json change-resource-record-sets --hosted-zone-id "</span><span class="k">${</span><span class="nv">HOSTED_ZONE_ID</span><span class="k">}</span><span class="sh">" --change-batch=file:///dev/stdin
{
    "Comment": "Update record to reflect new TTL for SOA and NS records",
    "Changes": [
        {
            "Action": "UPSERT",
            "ResourceRecordSet":
</span><span class="k">${</span><span class="nv">RESOURCE_RECORD_SET_SOA</span><span class="k">}</span><span class="sh">
        },
        {
            "Action": "UPSERT",
            "ResourceRecordSet":
</span><span class="k">${</span><span class="nv">RESOURCE_RECORD_SET_NS</span><span class="k">}</span><span class="sh">
        }
    ]
}
</span><span class="no">EOF
</span></pre></table></code></div></div><h2 id="create-amazon-eks"><span class="me-2">Create Amazon EKS</span><a href="#create-amazon-eks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://raw.githubusercontent.com/aws-samples/eks-workshop/65b766c494a5b4f5420b2912d8373c4957163541/static/images/3-service-animated.gif" class="popup img-link shimmer"><img src="https://raw.githubusercontent.com/aws-samples/eks-workshop/65b766c494a5b4f5420b2912d8373c4957163541/static/images/3-service-animated.gif" alt="EKS" title="EKS" loading="lazy"></a></p><p>Create <a href="https://aws.amazon.com/eks/">Amazon EKS</a> in AWS by using <a href="https://eksctl.io/">eksctl</a>. It’s a tool from Weaveworks based on official AWS CloudFormation templates which will be used to launch and configure our EKS cluster and nodes.</p><p><a href="https://raw.githubusercontent.com/weaveworks/eksctl/c365149fc1a0b8d357139cbd6cda5aee8841c16c/logo/eksctl.png" class="popup img-link shimmer"><img src="https://raw.githubusercontent.com/weaveworks/eksctl/c365149fc1a0b8d357139cbd6cda5aee8841c16c/logo/eksctl.png" alt="eksctl" title="eksctl" loading="lazy"></a></p><p>Generate SSH key if not exists:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">test</span> <span class="nt">-f</span> ~/.ssh/id_rsa.pub <span class="o">||</span> <span class="o">(</span><span class="nb">install</span> <span class="nt">-m</span> 0700 <span class="nt">-d</span> ~/.ssh <span class="o">&amp;&amp;</span> ssh-keygen <span class="nt">-b</span> 2048 <span class="nt">-t</span> rsa <span class="nt">-f</span> ~/.ssh/id_rsa <span class="nt">-q</span> <span class="nt">-N</span> <span class="s2">""</span><span class="o">)</span>
</pre></table></code></div></div><p>Create the Amazon EKS cluster with Calico using <code class="language-plaintext highlighter-rouge">eksctl</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
</pre><td class="rouge-code"><pre><span class="nb">cat</span> <span class="o">&gt;</span> <span class="s2">"tmp/</span><span class="k">${</span><span class="nv">CLUSTER_FQDN</span><span class="k">}</span><span class="s2">/eksctl.yaml"</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig
metadata:
  name: </span><span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span><span class="sh">
  region: </span><span class="k">${</span><span class="nv">AWS_DEFAULT_REGION</span><span class="k">}</span><span class="sh">
  version: "1.21"
  tags: &amp;tags
</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">TAGS</span><span class="k">}</span><span class="s2">"</span> | <span class="nb">sed</span> <span class="s2">"s/ /</span><span class="se">\\</span><span class="s2">n    /g; s/^/    /g; s/=/: /g"</span><span class="si">)</span><span class="sh">
availabilityZones:
  - </span><span class="k">${</span><span class="nv">AWS_DEFAULT_REGION</span><span class="k">}</span><span class="sh">a
  - </span><span class="k">${</span><span class="nv">AWS_DEFAULT_REGION</span><span class="k">}</span><span class="sh">b
iam:
  withOIDC: true
  serviceAccounts:
    - metadata:
        name: aws-load-balancer-controller
        namespace: kube-system
      wellKnownPolicies:
        awsLoadBalancerController: true
    - metadata:
        name: cert-manager
        namespace: cert-manager
      wellKnownPolicies:
        certManager: true
    - metadata:
        name: cluster-autoscaler
        namespace: kube-system
      wellKnownPolicies:
        autoScaler: true
    - metadata:
        name: external-dns
        namespace: external-dns
      wellKnownPolicies:
        externalDNS: true
    - metadata:
        name: ebs-csi-controller-sa
        namespace: kube-system
      wellKnownPolicies:
        ebsCSIController: true
    - metadata:
        name: harbor
        namespace: harbor
      attachPolicyARNs:
        - </span><span class="k">${</span><span class="nv">S3_POLICY_ARN</span><span class="k">}</span><span class="sh">
    - metadata:
        name: velero
        namespace: velero
      attachPolicyARNs:
        - </span><span class="k">${</span><span class="nv">S3_POLICY_ARN</span><span class="k">}</span><span class="sh">
    - metadata:
        name: s3-test
        namespace: s3-test
      attachPolicyARNs:
        - </span><span class="k">${</span><span class="nv">S3_POLICY_ARN</span><span class="k">}</span><span class="sh">
    - metadata:
        name: grafana
        namespace: kube-prometheus-stack
      attachPolicyARNs:
        - arn:aws:iam::aws:policy/AmazonPrometheusQueryAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
      attachPolicy:
        Version: 2012-10-17
        Statement:
        - Sid: AllowReadingTagsInstancesRegionsFromEC2
          Effect: Allow
          Action:
          - ec2:DescribeTags
          - ec2:DescribeInstances
          - ec2:DescribeRegions
          Resource: "*"
        - Sid: AllowReadingResourcesForTags
          Effect: Allow
          Action: tag:GetResources
          Resource: "*"
    - metadata:
        name: kube-prometheus-stack-prometheus
        namespace: kube-prometheus-stack
      attachPolicyARNs:
        - arn:aws:iam::aws:policy/AmazonPrometheusQueryAccess
        - arn:aws:iam::aws:policy/AmazonPrometheusRemoteWriteAccess
    - metadata:
        name: efs-csi-controller-sa
        namespace: kube-system
      wellKnownPolicies:
        efsCSIController: true
    - metadata:
        name: vault
        namespace: vault
      attachPolicy:
        Version: 2012-10-17
        Statement:
        - Sid: VaultKMSUnseal
          Effect: Allow
          Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:DescribeKey
          Resource:
          - "</span><span class="k">${</span><span class="nv">KMS_KEY_ARN</span><span class="k">}</span><span class="sh">"
    - metadata:
        name: kuard
        namespace: kuard
      attachPolicy:
        Version: 2012-10-17
        Statement:
        - Sid: AllowSecretManagerAccess
          Effect: Allow
          Action:
          - secretsmanager:GetSecretValue
          - secretsmanager:DescribeSecret
          Resource:
          - "arn:aws:secretsmanager:*:*:secret:*"
        - Sid: AllowKMSAccess
          Effect: Allow
          Action:
          - kms:Decrypt
          Resource:
          - "</span><span class="k">${</span><span class="nv">KMS_KEY_ARN</span><span class="k">}</span><span class="sh">"
vpc:
  nat:
    gateway: Disable
managedNodeGroups:
  - name: managed-ng-1
    amiFamily: Bottlerocket
    instanceType: t3.xlarge
    instancePrefix: ruzickap
    desiredCapacity: 3
    minSize: 2
    maxSize: 5
    volumeSize: 30
    labels:
      role: worker
    tags: *tags
    iam:
      withAddonPolicies:
        autoScaler: true
        cloudWatch: true
        ebs: true
        efs: true
    maxPodsPerNode: 1000
    volumeEncrypted: true
    volumeKmsKeyID: </span><span class="k">${</span><span class="nv">KMS_KEY_ID</span><span class="k">}</span><span class="sh">
fargateProfiles:
  - name: fp-fgtest
    selectors:
      - namespace: fgtest
    tags: *tags
secretsEncryption:
  keyARN: </span><span class="k">${</span><span class="nv">KMS_KEY_ARN</span><span class="k">}</span><span class="sh">
cloudWatch:
  clusterLogging:
    enableTypes:
      - authenticator
</span><span class="no">EOF

</span><span class="k">if</span> <span class="o">!</span> eksctl get clusters <span class="nt">--name</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span><span class="s2">"</span> &amp;&gt; /dev/null<span class="p">;</span> <span class="k">then
  </span>eksctl create cluster <span class="nt">--config-file</span> <span class="s2">"tmp/</span><span class="k">${</span><span class="nv">CLUSTER_FQDN</span><span class="k">}</span><span class="s2">/eksctl.yaml"</span> <span class="nt">--kubeconfig</span> <span class="s2">"</span><span class="k">${</span><span class="nv">KUBECONFIG</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--without-nodegroup</span>
  kubectl delete daemonset <span class="nt">-n</span> kube-system aws-node
  kubectl apply <span class="nt">-f</span> https://docs.projectcalico.org/archive/v3.20/manifests/calico-vxlan.yaml
  eksctl create nodegroup <span class="nt">--config-file</span> <span class="s2">"tmp/</span><span class="k">${</span><span class="nv">CLUSTER_FQDN</span><span class="k">}</span><span class="s2">/eksctl.yaml"</span>
<span class="k">fi</span>
</pre></table></code></div></div><p>Output:</p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
</pre><td class="rouge-code"><pre>2021-11-29 17:52:50 [ℹ]  eksctl version 0.75.0
2021-11-29 17:52:50 [ℹ]  using region eu-west-1
2021-11-29 17:52:50 [ℹ]  subnets for eu-west-1a - public:192.168.0.0/19 private:192.168.64.0/19
2021-11-29 17:52:50 [ℹ]  subnets for eu-west-1b - public:192.168.32.0/19 private:192.168.96.0/19
2021-11-29 17:52:50 [ℹ]  using Kubernetes version 1.21
2021-11-29 17:52:50 [ℹ]  creating EKS cluster "kube1" in "eu-west-1" region with Fargate profile
2021-11-29 17:52:50 [ℹ]  will create a CloudFormation stack for cluster itself and 0 nodegroup stack(s)
2021-11-29 17:52:50 [ℹ]  will create a CloudFormation stack for cluster itself and 0 managed nodegroup stack(s)
2021-11-29 17:52:50 [ℹ]  if you encounter any issues, check CloudFormation console or try 'eksctl utils describe-stacks --region=eu-west-1 --cluster=kube1'
2021-11-29 17:52:50 [ℹ]  Kubernetes API endpoint access will use default of {publicAccess=true, privateAccess=false} for cluster "kube1" in "eu-west-1"
2021-11-29 17:52:50 [ℹ]
2 sequential tasks: { create cluster control plane "kube1",
    7 sequential sub-tasks: {
        wait for control plane to become ready,
        tag cluster,
        update CloudWatch logging configuration,
        create fargate profiles,
        associate IAM OIDC provider,
        14 parallel sub-tasks: {
            2 sequential sub-tasks: {
                create IAM role for serviceaccount "kube-system/aws-load-balancer-controller",
                create serviceaccount "kube-system/aws-load-balancer-controller",
            },
            2 sequential sub-tasks: {
                create IAM role for serviceaccount "cert-manager/cert-manager",
                create serviceaccount "cert-manager/cert-manager",
            },
            2 sequential sub-tasks: {
                create IAM role for serviceaccount "kube-system/cluster-autoscaler",
                create serviceaccount "kube-system/cluster-autoscaler",
            },
            2 sequential sub-tasks: {
                create IAM role for serviceaccount "external-dns/external-dns",
                create serviceaccount "external-dns/external-dns",
            },
            2 sequential sub-tasks: {
                create IAM role for serviceaccount "kube-system/ebs-csi-controller-sa",
                create serviceaccount "kube-system/ebs-csi-controller-sa",
            },
            2 sequential sub-tasks: {
                create IAM role for serviceaccount "harbor/harbor",
                create serviceaccount "harbor/harbor",
            },
            2 sequential sub-tasks: {
                create IAM role for serviceaccount "velero/velero",
                create serviceaccount "velero/velero",
            },
            2 sequential sub-tasks: {
                create IAM role for serviceaccount "s3-test/s3-test",
                create serviceaccount "s3-test/s3-test",
            },
            2 sequential sub-tasks: {
                create IAM role for serviceaccount "kube-prometheus-stack/grafana",
                create serviceaccount "kube-prometheus-stack/grafana",
            },
            2 sequential sub-tasks: {
                create IAM role for serviceaccount "kube-prometheus-stack/kube-prometheus-stack-prometheus",
                create serviceaccount "kube-prometheus-stack/kube-prometheus-stack-prometheus",
            },
            2 sequential sub-tasks: {
                create IAM role for serviceaccount "kube-system/efs-csi-controller-sa",
                create serviceaccount "kube-system/efs-csi-controller-sa",
            },
            2 sequential sub-tasks: {
                create IAM role for serviceaccount "vault/vault",
                create serviceaccount "vault/vault",
            },
            2 sequential sub-tasks: {
                create IAM role for serviceaccount "kuard/kuard",
                create serviceaccount "kuard/kuard",
            },
            2 sequential sub-tasks: {
                create IAM role for serviceaccount "kube-system/aws-node",
                create serviceaccount "kube-system/aws-node",
            },
        },
        restart daemonset "kube-system/aws-node",
    }
}
2021-11-29 17:52:50 [ℹ]  building cluster stack "eksctl-kube1-cluster"
2021-11-29 17:52:50 [ℹ]  deploying stack "eksctl-kube1-cluster"
2021-11-29 17:53:21 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-cluster"
...
2021-11-29 18:05:55 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-cluster"
2021-11-29 18:07:59 [✔]  tagged EKS cluster (Owner=petr.ruzicka@gmail.com, Squad=Cloud_Container_Platform, compliance:na:defender=bottlerocket, Environment=Dev, Group=Cloud_Native)
2021-11-29 18:08:00 [ℹ]  waiting for requested "LoggingUpdate" in cluster "kube1" to succeed
...
2021-11-29 18:08:53 [ℹ]  waiting for requested "LoggingUpdate" in cluster "kube1" to succeed
2021-11-29 18:08:54 [✔]  configured CloudWatch logging for cluster "kube1" in "eu-west-1" (enabled types: authenticator &amp; disabled types: api, audit, controllerManager, scheduler)
2021-11-29 18:08:54 [ℹ]  creating Fargate profile "fp-fgtest" on EKS cluster "kube1"
2021-11-29 18:13:12 [ℹ]  created Fargate profile "fp-fgtest" on EKS cluster "kube1"
2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"
2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"
2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-velero-velero"
2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"
2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"
2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"
2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-node"
2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"
2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"
2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-kube-prometheus-stack-prometheus"
2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"
2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-s3-test-s3-test"
2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"
2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-harbor-harbor"
2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"
2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"
2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-harbor-harbor"
2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-harbor-harbor"
2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"
2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"
2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-s3-test-s3-test"
2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-s3-test-s3-test"
2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"
2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"
2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"
2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"
2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"
2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"
2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-velero-velero"
2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-velero-velero"
2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"
2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"
2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"
2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"
2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-kube-prometheus-stack-prometheus"
2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-kube-prometheus-stack-prometheus"
2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-node"
2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-node"
2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"
2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"
2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"
2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"
2021-11-29 18:18:00 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"
2021-11-29 18:18:00 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"
2021-11-29 18:18:01 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-velero-velero"
2021-11-29 18:18:02 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"
2021-11-29 18:18:02 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-harbor-harbor"
2021-11-29 18:18:02 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-s3-test-s3-test"
2021-11-29 18:18:02 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"
2021-11-29 18:18:03 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"
2021-11-29 18:18:03 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"
2021-11-29 18:18:03 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"
2021-11-29 18:18:04 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"
2021-11-29 18:18:04 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-node"
2021-11-29 18:18:04 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-kube-prometheus-stack-prometheus"
2021-11-29 18:18:05 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"
2021-11-29 18:18:17 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-harbor-harbor"
2021-11-29 18:18:18 [ℹ]  created namespace "harbor"
2021-11-29 18:18:18 [ℹ]  created serviceaccount "harbor/harbor"
2021-11-29 18:18:18 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-s3-test-s3-test"
2021-11-29 18:18:18 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"
2021-11-29 18:18:18 [ℹ]  created namespace "s3-test"
2021-11-29 18:18:18 [ℹ]  created serviceaccount "s3-test/s3-test"
2021-11-29 18:18:19 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-velero-velero"
2021-11-29 18:18:19 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"
2021-11-29 18:18:19 [ℹ]  created namespace "velero"
2021-11-29 18:18:19 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"
2021-11-29 18:18:20 [ℹ]  created serviceaccount "velero/velero"
2021-11-29 18:18:20 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"
2021-11-29 18:18:20 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"
2021-11-29 18:18:21 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-kube-prometheus-stack-prometheus"
2021-11-29 18:18:21 [ℹ]  created namespace "kube-prometheus-stack"
2021-11-29 18:18:21 [ℹ]  created serviceaccount "kube-prometheus-stack/kube-prometheus-stack-prometheus"
2021-11-29 18:18:21 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"
2021-11-29 18:18:21 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"
2021-11-29 18:18:24 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"
2021-11-29 18:18:24 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"
2021-11-29 18:18:24 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-node"
2021-11-29 18:18:24 [ℹ]  serviceaccount "kube-system/aws-node" already exists
2021-11-29 18:18:24 [ℹ]  updated serviceaccount "kube-system/aws-node"
2021-11-29 18:18:35 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"
2021-11-29 18:18:36 [ℹ]  created serviceaccount "kube-system/cluster-autoscaler"
2021-11-29 18:18:37 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"
2021-11-29 18:18:38 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"
2021-11-29 18:18:38 [ℹ]  created serviceaccount "kube-prometheus-stack/grafana"
2021-11-29 18:18:38 [ℹ]  created namespace "kuard"
2021-11-29 18:18:38 [ℹ]  created serviceaccount "kuard/kuard"
2021-11-29 18:18:38 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"
2021-11-29 18:18:38 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"
2021-11-29 18:18:38 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"
2021-11-29 18:18:38 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"
2021-11-29 18:18:38 [ℹ]  created namespace "vault"
2021-11-29 18:18:39 [ℹ]  created serviceaccount "vault/vault"
2021-11-29 18:18:39 [ℹ]  created namespace "cert-manager"
2021-11-29 18:18:39 [ℹ]  created serviceaccount "cert-manager/cert-manager"
2021-11-29 18:18:39 [ℹ]  created serviceaccount "kube-system/aws-load-balancer-controller"
2021-11-29 18:18:39 [ℹ]  created serviceaccount "kube-system/ebs-csi-controller-sa"
2021-11-29 18:18:41 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"
2021-11-29 18:18:42 [ℹ]  created namespace "external-dns"
2021-11-29 18:18:42 [ℹ]  created serviceaccount "external-dns/external-dns"
2021-11-29 18:18:42 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"
2021-11-29 18:18:43 [ℹ]  created serviceaccount "kube-system/efs-csi-controller-sa"
2021-11-29 18:18:43 [ℹ]  daemonset "kube-system/aws-node" restarted
2021-11-29 18:18:43 [ℹ]  waiting for the control plane availability...
2021-11-29 18:18:43 [✔]  saved kubeconfig as "/Users/ruzickap/git/k8s-eks-bottlerocket-fargate/kubeconfig-kube1.conf"
2021-11-29 18:18:43 [ℹ]  no tasks
2021-11-29 18:18:43 [✔]  all EKS cluster resources for "kube1" have been created
2021-11-29 18:18:44 [ℹ]  kubectl command should work with "/Users/ruzickap/git/k8s-eks-bottlerocket-fargate/kubeconfig-kube1.conf", try 'kubectl --kubeconfig=/Users/ruzickap/git/k8s-eks-bottlerocket-fargate/kubeconfig-kube1.conf get nodes'
2021-11-29 18:18:44 [✔]  EKS cluster "kube1" in "eu-west-1" region is ready
daemonset.apps "aws-node" deleted
configmap/calico-config created
customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created
clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrole.rbac.authorization.k8s.io/calico-node created
clusterrolebinding.rbac.authorization.k8s.io/calico-node created
daemonset.apps/calico-node created
serviceaccount/calico-node created
deployment.apps/calico-kube-controllers created
serviceaccount/calico-kube-controllers created
Warning: policy/v1beta1 PodDisruptionBudget is deprecated in v1.21+, unavailable in v1.25+; use policy/v1 PodDisruptionBudget
poddisruptionbudget.policy/calico-kube-controllers created
2021-11-29 18:18:59 [ℹ]  eksctl version 0.75.0
2021-11-29 18:18:59 [ℹ]  using region eu-west-1
2021-11-29 18:19:15 [ℹ]  nodegroup "managed-ng-1" will use "" [Bottlerocket/1.21]
2021-11-29 18:19:32 [ℹ]  1 nodegroup (managed-ng-1) was included (based on the include/exclude rules)
2021-11-29 18:19:32 [ℹ]  will create a CloudFormation stack for each of 1 managed nodegroups in cluster "kube1"
2021-11-29 18:19:32 [ℹ]
2 sequential tasks: { fix cluster compatibility, 1 task: { 1 task: { create managed nodegroup "managed-ng-1" } }
}
2021-11-29 18:19:32 [ℹ]  checking cluster stack for missing resources
2021-11-29 18:19:41 [ℹ]  cluster stack has all required resources
2021-11-29 18:19:41 [ℹ]  building managed nodegroup stack "eksctl-kube1-nodegroup-managed-ng-1"
2021-11-29 18:19:41 [ℹ]  deploying stack "eksctl-kube1-nodegroup-managed-ng-1"
2021-11-29 18:19:41 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-nodegroup-managed-ng-1"
...
2021-11-29 18:22:59 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-nodegroup-managed-ng-1"
2021-11-29 18:23:00 [ℹ]  no tasks
2021-11-29 18:23:00 [✔]  created 0 nodegroup(s) in cluster "kube1"
2021-11-29 18:23:00 [ℹ]  nodegroup "managed-ng-1" has 3 node(s)
2021-11-29 18:23:00 [ℹ]  node "ip-192-168-31-11.eu-west-1.compute.internal" is ready
2021-11-29 18:23:00 [ℹ]  node "ip-192-168-56-82.eu-west-1.compute.internal" is ready
2021-11-29 18:23:00 [ℹ]  node "ip-192-168-60-184.eu-west-1.compute.internal" is ready
2021-11-29 18:23:00 [ℹ]  waiting for at least 2 node(s) to become ready in "managed-ng-1"
2021-11-29 18:23:00 [ℹ]  nodegroup "managed-ng-1" has 3 node(s)
2021-11-29 18:23:00 [ℹ]  node "ip-192-168-31-11.eu-west-1.compute.internal" is ready
2021-11-29 18:23:00 [ℹ]  node "ip-192-168-56-82.eu-west-1.compute.internal" is ready
2021-11-29 18:23:00 [ℹ]  node "ip-192-168-60-184.eu-west-1.compute.internal" is ready
2021-11-29 18:23:00 [✔]  created 1 managed nodegroup(s) in cluster "kube1"
2021-11-29 18:23:12 [ℹ]  checking security group configuration for all nodegroups
2021-11-29 18:23:12 [ℹ]  all nodegroups have up-to-date cloudformation templates
</pre></table></code></div></div><p>When the cluster is ready it immediately start pushing logs to CloudWatch under <code class="language-plaintext highlighter-rouge">/aws/eks/kube1/cluster</code>.</p><p>Add add the user or role to the aws-auth ConfigMap. This is handy if you are using different user for cli operations and different user/role for accessing the AWS Console to see EKS Workloads in Cluster’s tab.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">!</span> eksctl get iamidentitymapping <span class="nt">--cluster</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--region</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">AWS_DEFAULT_REGION</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--arn</span><span class="o">=</span><span class="k">${</span><span class="nv">AWS_CONSOLE_ADMIN_ROLE_ARN</span><span class="k">}</span><span class="p">;</span> <span class="k">then
  </span>eksctl create iamidentitymapping <span class="nt">--cluster</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--region</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">AWS_DEFAULT_REGION</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--arn</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">AWS_CONSOLE_ADMIN_ROLE_ARN</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--group</span> system:masters <span class="nt">--username</span> admin
<span class="k">fi</span>
</pre></table></code></div></div><p>Output:</p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>2021-11-29 18:23:13 [ℹ]  eksctl version 0.75.0
2021-11-29 18:23:13 [ℹ]  using region eu-west-1
2021-11-29 18:23:14 [ℹ]  adding identity "arn:aws:iam::7xxxxxxxxxx7:role/AxxxxxxxxxxxxN" to auth ConfigMap
</pre></table></code></div></div><p>Check the nodes+pods and max number of nodes which can be scheduled on one node:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl get nodes,pods <span class="nt">-o</span> wide <span class="nt">--all-namespaces</span>
</pre></table></code></div></div><p>Output:</p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>NAME                                                STATUS   ROLES    AGE   VERSION   INTERNAL-IP      EXTERNAL-IP     OS-IMAGE                               KERNEL-VERSION   CONTAINER-RUNTIME
node/ip-192-168-31-11.eu-west-1.compute.internal    Ready    &lt;none&gt;   81s   v1.21.6   192.168.31.11    54.194.69.158   Bottlerocket OS 1.4.1 (aws-k8s-1.21)   5.10.68          containerd://1.5.5+bottlerocket
node/ip-192-168-56-82.eu-west-1.compute.internal    Ready    &lt;none&gt;   86s   v1.21.6   192.168.56.82    3.250.52.238    Bottlerocket OS 1.4.1 (aws-k8s-1.21)   5.10.68          containerd://1.5.5+bottlerocket
node/ip-192-168-60-184.eu-west-1.compute.internal   Ready    &lt;none&gt;   84s   v1.21.6   192.168.60.184   54.75.89.58     Bottlerocket OS 1.4.1 (aws-k8s-1.21)   5.10.68          containerd://1.5.5+bottlerocket

NAMESPACE     NAME                                           READY   STATUS    RESTARTS   AGE     IP               NODE                                           NOMINATED NODE   READINESS GATES
kube-system   pod/calico-kube-controllers-6c85b56fcb-5g5cq   1/1     Running   0          4m16s   172.16.166.130   ip-192-168-56-82.eu-west-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-system   pod/calico-node-4whs8                          1/1     Running   0          84s     192.168.60.184   ip-192-168-60-184.eu-west-1.compute.internal   &lt;none&gt;           &lt;none&gt;
kube-system   pod/calico-node-nbjsn                          1/1     Running   0          86s     192.168.56.82    ip-192-168-56-82.eu-west-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-system   pod/calico-node-nnhwz                          1/1     Running   0          81s     192.168.31.11    ip-192-168-31-11.eu-west-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-system   pod/coredns-7cc879f8db-ct5bp                   1/1     Running   0          21m     172.16.166.131   ip-192-168-56-82.eu-west-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-system   pod/coredns-7cc879f8db-h4mbs                   1/1     Running   0          21m     172.16.166.129   ip-192-168-56-82.eu-west-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-system   pod/kube-proxy-9c9wk                           1/1     Running   0          86s     192.168.56.82    ip-192-168-56-82.eu-west-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-system   pod/kube-proxy-gqbt7                           1/1     Running   0          81s     192.168.31.11    ip-192-168-31-11.eu-west-1.compute.internal    &lt;none&gt;           &lt;none&gt;
kube-system   pod/kube-proxy-q7pzh                           1/1     Running   0          84s     192.168.60.184   ip-192-168-60-184.eu-west-1.compute.internal   &lt;none&gt;           &lt;none&gt;
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/jekyll-chirpy//categories/eks/">EKS</a>, <a href="/jekyll-chirpy//categories/pipelines/">Pipelines</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/jekyll-chirpy//tags/eks/" class="post-tag no-text-decoration" >EKS</a> <a href="/jekyll-chirpy//tags/pipeline-templates/" class="post-tag no-text-decoration" >Pipeline Templates</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Test%20EKS%20Post%20-%20Petr's%20Blog&url=%2Fjekyll-chirpy%2Fposts%2Ftest-eks-post%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Test%20EKS%20Post%20-%20Petr's%20Blog&u=%2Fjekyll-chirpy%2Fposts%2Ftest-eks-post%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=%2Fjekyll-chirpy%2Fposts%2Ftest-eks-post%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/jekyll-chirpy/posts/first-post/">First_post</a><li class="text-truncate lh-lg"> <a href="/jekyll-chirpy/posts/test-post-123/">Test Post 123</a><li class="text-truncate lh-lg"> <a href="/jekyll-chirpy/posts/test-eks-post/">Test EKS Post</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/branch-protection-rules/">Branch Protection Rules</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/codeql/">CodeQL</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/eks/">EKS</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/first/">first</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/first-post/">first_post</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/github-actions/">GitHub Actions</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/github-advanced-security/">GitHub Advanced Security</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/github/">GitHub</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/pipeline-templates/">Pipeline Templates</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/policy-enforcement/">Policy Enforcement</a></div></section></div><section id="toc-wrapper" class="d-none ps-0 pe-4"><h2 class="panel-heading ps-3 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"><div class="btn btn-outline-primary disabled" aria-label="Older"><p>-</p></div><a href="/jekyll-chirpy//posts/test-post-123/" class="btn btn-outline-primary" aria-label="Newer" ><p>Test Post 123</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2024</time> <a href="https://twitter.com/Ruzicka_Petr">Petr Ruzicka</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.0.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/branch-protection-rules/">Branch Protection Rules</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/codeql/">CodeQL</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/eks/">EKS</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/first/">first</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/first-post/">first_post</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/github-actions/">GitHub Actions</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/github-advanced-security/">GitHub Advanced Security</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/github/">GitHub</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/pipeline-templates/">Pipeline Templates</a> <a class="post-tag btn btn-outline-primary" href="/jekyll-chirpy/tags/policy-enforcement/">Policy Enforcement</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.11/dayjs.min.js,npm/dayjs@1.11.11/locale/en.min.js,npm/dayjs@1.11.11/plugin/relativeTime.min.js,npm/dayjs@1.11.11/plugin/localizedFormat.min.js,npm/tocbot@4.27.20/dist/tocbot.min.js"></script> <script src="/jekyll-chirpy/assets/js/dist/post.min.js"></script> <script defer src="/jekyll-chirpy/assets/js/dist/app.min.js"></script> <script>SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/jekyll-chirpy/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
